
<!doctype html>
<html lang="it" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://marcocecca00.github.io/recas-containers-docs/">
      
      
      
      
        
      
      
      <link rel="icon" href="assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.0">
    
    
      
        <title>Guida pratica - HTCondor & Containers</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/main.618322db.min.css">
      
        
        <link rel="stylesheet" href="assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="css/overrides.css">
    
    <script>__md_scope=new URL(".",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="blue-grey" data-md-color-accent="deep-orange">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#uso-di-immagini-apptainersingularity-con-htcondor-su-recas" class="md-skip">
          Vai al contenuto
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Intestazione">
    <a href="." title="Guida pratica - HTCondor &amp; Containers" class="md-header__button md-logo" aria-label="Guida pratica - HTCondor & Containers" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Guida pratica - HTCondor & Containers
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Uso di immagini Apptainer/Singularity con HTCondor su ReCaS
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="blue-grey" data-md-color-accent="deep-orange"  aria-label="Passa al tema scuro"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Passa al tema scuro" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="blue-grey" data-md-color-accent="deep-orange"  aria-label="Passa al tema chiaro"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Passa al tema chiaro" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Cerca" placeholder="Cerca" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Cerca">
        
        <button type="reset" class="md-search__icon md-icon" title="Cancella" aria-label="Cancella" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Inizializza la ricerca
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/marcocecca00/recas-containers-docs" title="Apri repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    recas-containers-docs
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



  

<nav class="md-nav md-nav--primary md-nav--integrated" aria-label="Navigazione" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="." title="Guida pratica - HTCondor &amp; Containers" class="md-nav__button md-logo" aria-label="Guida pratica - HTCondor & Containers" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Guida pratica - HTCondor & Containers
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/marcocecca00/recas-containers-docs" title="Apri repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    recas-containers-docs
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Uso di immagini Apptainer/Singularity con HTCondor su ReCaS
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="." class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Uso di immagini Apptainer/Singularity con HTCondor su ReCaS
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Indice">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Indice
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduzione" class="md-nav__link">
    <span class="md-ellipsis">
      
        Introduzione
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sec-concetti-base" class="md-nav__link">
    <span class="md-ellipsis">
      
        Concetti di base: container, Apptainer e HTCondor
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sec-organizzazione" class="md-nav__link">
    <span class="md-ellipsis">
      
        Organizzazione delle directory
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sec-esempi" class="md-nav__link">
    <span class="md-ellipsis">
      
        Esempi
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Esempi">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sec-esempio1" class="md-nav__link">
    <span class="md-ellipsis">
      
        Esempio 1: test dell'immagine Geant4
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sec-esempio2" class="md-nav__link">
    <span class="md-ellipsis">
      
        Esempio 2: build dell’esempio B5 di Geant4
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sec-esempio3" class="md-nav__link">
    <span class="md-ellipsis">
      
        Esempio 3: run dell’esempio B5
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sec-esempio4" class="md-nav__link">
    <span class="md-ellipsis">
      
        Esempio 4: build e run di B5 in un unico job
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sec-esempio5" class="md-nav__link">
    <span class="md-ellipsis">
      
        Esempio 5: progetto CsI-WLS con Python
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sec-docker-sif" class="md-nav__link">
    <span class="md-ellipsis">
      
        Costruzione di un’immagine Docker e conversione in SIF
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Costruzione di un’immagine Docker e conversione in SIF">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#comandi-essenziali-docker" class="md-nav__link">
    <span class="md-ellipsis">
      
        Comandi essenziali Docker
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#comandi-essenziali-apptainersingularity" class="md-nav__link">
    <span class="md-ellipsis">
      
        Comandi essenziali Apptainer/Singularity
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sec-kubernetes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Prospettive: uso di Kubernetes con container
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sec-images" class="md-nav__link">
    <span class="md-ellipsis">
      
        Immagini Docker / Apptainer disponibili su ReCaS
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#appendice" class="md-nav__link">
    <span class="md-ellipsis">
      
        Appendice
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Appendice">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sec-dockerfile-esempio" class="md-nav__link">
    <span class="md-ellipsis">
      
        Dockerfile di esempio per ambiente Geant4/ROOT
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#riferimenti-ufficiali-recas" class="md-nav__link">
    <span class="md-ellipsis">
      
        Riferimenti ufficiali ReCaS
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
    <a href="https://github.com/marcocecca00/recas-containers-docs/edit/master/docs/index.md" title="Modifica" class="md-content__button md-icon" rel="edit">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg>
    </a>
  
  


<h1 id="uso-di-immagini-apptainersingularity-con-htcondor-su-recas">Uso di immagini Apptainer/Singularity con HTCondor su ReCaS<a class="headerlink" href="#uso-di-immagini-apptainersingularity-con-htcondor-su-recas" title="Permanent link">&para;</a></h1>
<h2 id="introduzione"><strong>Introduzione</strong><a class="headerlink" href="#introduzione" title="Permanent link">&para;</a></h2>
<p>Questa guida descrive in modo operativo come usare immagini Apptainer/Singularity (file <code>.sif</code>) insieme a HTCondor sul cluster ReCaS. L’idea di fondo è che ci sia almeno un utente “manutentore” (che chiameremo <code>alice</code>) che possa costruire immagini Docker su una macchina dedicata, convertirle in immagini Apptainer/Singularity e metterle a disposizione di tutti in una posizione condivisa su lustre. Gli altri utenti (ad esempio <code>bob</code>) non devono occuparsi della parte Docker: si limitano a usare le immagini <code>.sif</code> già pronte all’interno dei job Condor, tramite <em>symlink</em> verso la directory condivisa di <code>alice</code>.</p>
<p>Nel seguito useremo come esempio un utente chiamato <code>bob</code> per i job Condor, mentre <code>alice</code> rappresenterà l’utente che ospita le immagini condivise. Per rendere gli esempi concreti, si assume che siano già presenti due immagini Apptainer nella directory condivisa di <code>alice</code>:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span>
<span class="normal"><a href="#__codelineno-0-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a>/lustrehome/alice/apptainer_images/G4_v10.6.3_NOMULTITHREAD.sif
<a id="__codelineno-0-2" name="__codelineno-0-2"></a>/lustrehome/alice/apptainer_images/G4_v11.3.1.sif
</code></pre></div></td></tr></table></div>
<p>Queste immagini contengono Ubuntu 24.04, Geant4, ROOT, Python3 con numpy e matplotlib. In particolare l’immagine <code>G4_v10.6.3_NOMULTITHREAD.sif</code> ha il multithreading disattivato per Geant4 ed è adatta ad applicazioni che richiedono esecuzione single-thread.</p>
<p>La sezione <a href="#sec-concetti-base">Concetti di base: container, Apptainer e HTCondor</a> introduce i concetti di base su container, Apptainer e HTCondor, mentre la sezione <a href="#sec-organizzazione">Organizzazione delle directory</a> propone una convenzione semplice per organizzare le directory su lustre dal punto di vista di <code>bob</code>.</p>
<p>La sezione <a href="#sec-esempi">Esempi</a> illustra cinque esempi completi di utilizzo: test dell’immagine, build dell’esempio B5 di Geant4, run di B5, build+run in un unico job e un caso reale con una simulazione Geant di una tile scintillante tra due piani di fibre WLS (CsI-WLS) e Python.</p>
<p>La sezione <a href="#sec-docker-sif">Costruzione di un’immagine Docker e conversione in SIF</a> mostra come costruire e convertire immagini Docker in <code>.sif</code>, mentre la sezione <a href="#sec-kubernetes">Prospettive: uso di Kubernetes con container</a> è prevista come estensione futura.</p>
<p>In Appendice, la sezione <a href="#sec-dockerfile-esempio">Dockerfile di esempio per ambiente Geant4/ROOT</a> contiene un Dockerfile di esempio.</p>
<p>Per comodità, la sezione <a href="#sec-images">Immagini Docker / Apptainer disponibili su ReCaS</a>
riporta un elenco aggiornato delle immagini attualmente disponibili e dei relativi percorso reali su lustre, che possono essere riutilizzate come base per nuovi workflow.</p>
<hr />
<h2 id="sec-concetti-base"><strong>Concetti di base: container, Apptainer e HTCondor</strong><a class="headerlink" href="#sec-concetti-base" title="Permanent link">&para;</a></h2>
<p>Prima di entrare negli esempi conviene chiarire cosa si intende per container e come Apptainer interagisce con HTCondor nel contesto del cluster ReCaS.</p>
<p>Un container è un ambiente software isolato, definito da un’immagine che contiene un sistema operativo minimale (ad esempio Ubuntu), le librerie e le applicazioni necessarie. Quando si avvia un container, il programma viene eseguito con quell’ambiente software, indipendentemente dal sistema operativo del nodo fisico. Nel nostro caso un’immagine <code>.sif</code> contiene Geant4, ROOT, Python e le relative dipendenze, così che un job Condor non deve installare o configurare nulla: trova tutto già predisposto.</p>
<p>Su ReCaS i container sono gestiti da Apptainer (discendente di Singularity), progettato per ambienti HPC multiutente. Un’immagine Apptainer è un file in sola lettura; durante il job, Apptainer monta il filesystem dell’immagine e allo stesso tempo monta la directory di lavoro dell’utente, in modo che il programma possa leggere e scrivere i propri file su lustre. Questo approccio è più leggero di una macchina virtuale, perché il kernel del sistema è condiviso e si avvia solo lo strato utente.</p>
<p>HTCondor si occupa di individuare i worker node disponibili, preparare la directory di lavoro e avviare Apptainer. Dal punto di vista dell’utente, la cosa fondamentale è capire il ruolo di tre parametri nel file di submit: <code>initialdir</code>, <code>executable</code> e <code>container_image</code>.</p>
<ul>
<li>La direttiva <code>initialdir</code> indica la directory sul filesystem di lustre che rappresenta la cartella di lavoro del job. Condor monta questa directory nel container come current working directory (CWD), quindi tutto ciò che viene scritto in CWD o in sottocartelle relative finisce direttamente in questa directory su lustre.</li>
<li>La direttiva <code>executable</code> indica lo script o l’eseguibile che verrà lanciato all’interno del container. Deve trovarsi nella <code>initialdir</code> o in una sua sottocartella ed è specificato nel file di submit con un percorso relativo.</li>
<li>La direttiva <code>container_image</code> indica quale immagine Apptainer usare. I test effettuati sul cluster hanno mostrato un comportamento pratico importante: Condor si aspetta che il valore di <code>container_image</code> sia il nome di un file presente nella <code>initialdir</code>. Per questa ragione, anche se l’immagine “reale” vive in una directory centrale, per ogni job conviene creare nella <code>initialdir</code> un symlink locale all’immagine e poi usare nel submit il nome del symlink (ad esempio un symlink a <code>/lustrehome/alice/apptainer_images/immagine.sif</code>).</li>
</ul>
<p>In pratica, quando Condor avvia Apptainer, la <code>initialdir</code> viene montata nel container come directory di lavoro corrente: non c’è copia dei file, tutto ciò che il job legge o scrive in CWD (e nelle sottocartelle relative) finisce direttamente sulla stessa directory di lustre.</p>
<div class="admonition warning">
<p class="admonition-title"> Attenzione: comportamento specifico di ReCaS</p>
<p>Il requisito che <code>container_image</code> debba essere il nome di un file presente nella
<code>initialdir</code> (tipicamente un symlink verso la <code>.sif</code> reale su lustre) è legato alla
configurazione di HTCondor su ReCaS. Al momento questa è la modalità supportata e
testata; in futuro potrebbero essere aggiunti anche path assoluti o altri meccanismi
per individuare l’immagine del container.</p>
</div>
<div class="admonition tip">
<p class="admonition-title">Cosa fa davvero HTCondor con <code>container_image</code></p>
<p>Quando nel file di submit si imposta:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-1-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a>container_image = G4_v11.3.1.sif
</code></pre></div></td></tr></table></div>
<p>dal punto di vista pratico HTCondor, sul worker node, fa qualcosa di
<strong>equivalente</strong> a:</p>
<p><div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-2-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a>apptainer<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>G4_v11.3.1.sif<span class="w"> </span>./script_che_hai_messo_in_executable.sh
</code></pre></div></td></tr></table></div>
<em>(oppure <code>singularity exec</code> a seconda del runtime disponibile).</em></p>
<p>Questo significa che:</p>
<ul>
<li>l’ambiente dentro il container è lo stesso che avresti lanciando
  <code>apptainer exec</code> a mano da shell;</li>
<li>le variabili d’ambiente e i PATH di Geant4/ROOT <strong>non vengono magicamente
  settati da Condor</strong>, ma solo:</li>
<li>da eventuali script di entrypoint dell’immagine;</li>
<li>oppure da quello che fai tu nello <code>executable</code> (ad es.):
    <div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-3-1">1</a></span>
<span class="normal"><a href="#__codelineno-3-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="nb">source</span><span class="w"> </span>/opt/geant4/bin/geant4.sh
<a id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="nb">source</span><span class="w"> </span>/opt/root/bin/thisroot.sh
</code></pre></div></td></tr></table></div></li>
</ul>
<p>Per questo, in tutti gli esempi della guida, gli script <code>*.sh</code> eseguiti
come <code>executable</code> fanno esplicitamente il <code>source</code> degli script di ambiente
di Geant4 e ROOT all’inizio.</p>
</div>
<p>Un esempio tipico è il seguente. Nella directory del job di <code>bob</code> si crea un link all’immagine condivisa di <code>alice</code>:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-4-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a>ln<span class="w"> </span>-sf<span class="w"> </span>/lustrehome/alice/apptainer_images/G4_v11.3.1.sif<span class="w"> </span>G4_v11.3.1.sif
</code></pre></div></td></tr></table></div>
<p>e nel file di submit si scrive:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-5-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="nv">container_image</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>G4_v11.3.1.sif
</code></pre></div></td></tr></table></div>
<p>In questo modo Condor trova il file <code>G4_v11.3.1.sif</code> nella <code>initialdir</code>, avvia Apptainer con quell’immagine e monta la <code>initialdir</code> all’interno del container. Da quel momento in poi lo script <code>executable</code> viene eseguito dentro il container e la directory di lavoro corrisponde alla directory dell’utente su lustre.</p>
<p>Gli esempi pratici della sezione <a href="#sec-esempi">Esempi</a> non fanno altro che declinare questo schema base in casi d’uso via via più complessi.</p>
<hr />
<h2 id="sec-organizzazione"><strong>Organizzazione delle directory</strong><a class="headerlink" href="#sec-organizzazione" title="Permanent link">&para;</a></h2>
<p>Per lavorare in modo ordinato conviene scegliere una convenzione semplice all’interno della propria home su lustre. Nel caso di <code>bob</code>, la directory di riferimento per i job è <code>/lustrehome/bob</code>, mentre l’utente manutentore <code>alice</code> usa <code>/lustrehome/alice</code> per ospitare le immagini condivise.</p>
<p>Le immagini Apptainer condivise dal manutentore possono essere raccolte in una directory dedicata, ad esempio <code>/lustrehome/alice/apptainer_images</code>. In questa directory si collocano i file <code>.sif</code> che <code>alice</code> ha costruito o recuperato. Nel nostro esempio vi si trovano <code>G4_v11.3.1.sif</code> e <code>G4_v10.6.3_NOMULTITHREAD.sif</code>.</p>
<p>Per gli esempi e i job Condor di <code>bob</code> si può usare una directory <code>condor_tests</code>. All’interno di <code>condor_tests</code> è utile creare sottodirectory dedicate per ciascun tipo di job. Ogni directory contiene i file di submit <code>.csi</code>, gli script <code>.sh</code>, un link locale all’immagine <code>.sif</code> (proveniente da <code>/lustrehome/alice/apptainer_images</code>) e una sottocartella <code>logs/</code> per gli output di Condor. Questa struttura rende chiaro dove si trova il codice sorgente, dove viene compilato il programma e dove finiscono i file prodotti dai job Condor, seguendo lo schema introdotto in <a href="#sec-concetti-base">Concetti di base: container, Apptainer e HTCondor</a> e utilizzato in tutti gli esempi successivi.</p>
<div class="admonition example">
<p class="admonition-title"> Esempio di gerarchia tipica su lustre</p>
<p>Una possibile organizzazione delle directory per <code>alice</code> (manutentore) e <code>bob</code>
(utente che sottomette i job) può essere:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-6-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-6-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-6-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-6-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-6-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-6-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-6-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-6-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-6-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-6-10">10</a></span>
<span class="normal"><a href="#__codelineno-6-11">11</a></span>
<span class="normal"><a href="#__codelineno-6-12">12</a></span>
<span class="normal"><a href="#__codelineno-6-13">13</a></span>
<span class="normal"><a href="#__codelineno-6-14">14</a></span>
<span class="normal"><a href="#__codelineno-6-15">15</a></span>
<span class="normal"><a href="#__codelineno-6-16">16</a></span>
<span class="normal"><a href="#__codelineno-6-17">17</a></span>
<span class="normal"><a href="#__codelineno-6-18">18</a></span>
<span class="normal"><a href="#__codelineno-6-19">19</a></span>
<span class="normal"><a href="#__codelineno-6-20">20</a></span>
<span class="normal"><a href="#__codelineno-6-21">21</a></span>
<span class="normal"><a href="#__codelineno-6-22">22</a></span>
<span class="normal"><a href="#__codelineno-6-23">23</a></span>
<span class="normal"><a href="#__codelineno-6-24">24</a></span>
<span class="normal"><a href="#__codelineno-6-25">25</a></span>
<span class="normal"><a href="#__codelineno-6-26">26</a></span>
<span class="normal"><a href="#__codelineno-6-27">27</a></span>
<span class="normal"><a href="#__codelineno-6-28">28</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1"></a>/lustrehome/alice/
<a id="__codelineno-6-2" name="__codelineno-6-2"></a>  apptainer_images/
<a id="__codelineno-6-3" name="__codelineno-6-3"></a>    G4_v11.3.1.sif
<a id="__codelineno-6-4" name="__codelineno-6-4"></a>    G4_v10.6.3_NOMULTITHREAD.sif
<a id="__codelineno-6-5" name="__codelineno-6-5"></a>
<a id="__codelineno-6-6" name="__codelineno-6-6"></a>/lustrehome/bob/
<a id="__codelineno-6-7" name="__codelineno-6-7"></a>  condor_tests/
<a id="__codelineno-6-8" name="__codelineno-6-8"></a>    test_container/
<a id="__codelineno-6-9" name="__codelineno-6-9"></a>      logs/
<a id="__codelineno-6-10" name="__codelineno-6-10"></a>      G4_v11.3.1.sif -&gt; /lustrehome/alice/apptainer_images/G4_v11.3.1.sif
<a id="__codelineno-6-11" name="__codelineno-6-11"></a>      test_container.sh
<a id="__codelineno-6-12" name="__codelineno-6-12"></a>      test_container.csi
<a id="__codelineno-6-13" name="__codelineno-6-13"></a>
<a id="__codelineno-6-14" name="__codelineno-6-14"></a>    build_B5_11.3.1/
<a id="__codelineno-6-15" name="__codelineno-6-15"></a>      logs/
<a id="__codelineno-6-16" name="__codelineno-6-16"></a>      G4_v11.3.1.sif -&gt; /lustrehome/alice/apptainer_images/G4_v11.3.1.sif
<a id="__codelineno-6-17" name="__codelineno-6-17"></a>      build_B5_exec.sh
<a id="__codelineno-6-18" name="__codelineno-6-18"></a>      build_B5_11.3.1.csi
<a id="__codelineno-6-19" name="__codelineno-6-19"></a>      B5_build_condor/      # directory di build creata dal job
<a id="__codelineno-6-20" name="__codelineno-6-20"></a>
<a id="__codelineno-6-21" name="__codelineno-6-21"></a>    run_B5_11.3.1/
<a id="__codelineno-6-22" name="__codelineno-6-22"></a>      logs/
<a id="__codelineno-6-23" name="__codelineno-6-23"></a>      G4_v11.3.1.sif -&gt; /lustrehome/alice/apptainer_images/G4_v11.3.1.sif
<a id="__codelineno-6-24" name="__codelineno-6-24"></a>      run_B5_exec.sh
<a id="__codelineno-6-25" name="__codelineno-6-25"></a>      run_B5_11.3.1.csi
<a id="__codelineno-6-26" name="__codelineno-6-26"></a>      exampleB5
<a id="__codelineno-6-27" name="__codelineno-6-27"></a>      run1.mac
<a id="__codelineno-6-28" name="__codelineno-6-28"></a>      # file di output prodotti da B5
</code></pre></div></td></tr></table></div>
<p>In questa configurazione:</p>
<ul>
<li><code>alice</code> mantiene tutte le immagini <code>.sif</code> in un’unica directory centrale;</li>
<li><code>bob</code> crea, per ogni tipo di job, una directory dedicata con i file <code>.csi</code>,
  gli script <code>.sh</code>, una sottocartella <code>logs/</code> e un symlink locale all’immagine <code>.sif</code>.</li>
</ul>
</div>
<hr />
<h2 id="sec-esempi"><strong>Esempi</strong><a class="headerlink" href="#sec-esempi" title="Permanent link">&para;</a></h2>
<p>In questa sezione sono riportati cinque esempi completi che illustrano come utilizzare immagini Apptainer/Singularity in combinazione con HTCondor. Gli esempi seguono un ordine progressivo, dal test più semplice fino a un caso realistico con un progetto Geant4 personalizzato:</p>
<ul>
<li><strong>Esempio <a href="#sec-esempio1">1</a></strong> – test minimale dell’immagine <code>.sif</code> per verificare la versione di Geant4, ROOT e Python e controllare che il container venga avviato correttamente su un worker node;</li>
<li><strong>Esempio <a href="#sec-esempio2">2</a></strong> – compilazione dell’esempio Geant4 B5 all’interno del container utilizzando CMake;</li>
<li><strong>Esempio <a href="#sec-esempio3">3</a></strong> – esecuzione di un binario Geant4 precompilato con una macro, in un job dedicato;</li>
<li><strong>Esempio <a href="#sec-esempio4">4</a></strong> – compilazione ed esecuzione dell’esempio B5 nello stesso job HTCondor, utile quando si vuole una build “pulita” per ogni run;</li>
<li><strong>Esempio <a href="#sec-esempio5">5</a></strong> – caso realistico con il progetto CsI-WLS, che prevede build con CMake e un batch di simulazioni pilotato da uno script Python.</li>
</ul>
<p>I template completi degli script <code>.sh</code> e dei file di submit <code>.csi</code> utilizzati negli esempi successivi sono disponibili nella cartella
<a href="https://github.com/marcocecca00/recas-containers-docs/tree/master/templates"><code>templates/</code></a> del repository GitHub.</p>
<p>In particolare:</p>
<ul>
<li><a href="https://github.com/marcocecca00/recas-containers-docs/tree/master/templates/Es1_test_container"><code>Es1_test_container</code></a></li>
<li><a href="https://github.com/marcocecca00/recas-containers-docs/tree/master/templates/Es2_build_geant_project"><code>Es2_build_geant_project</code></a></li>
<li><a href="https://github.com/marcocecca00/recas-containers-docs/tree/master/templates/Es3_run_geant_exec"><code>Es3_run_geant_exec</code></a></li>
<li><a href="https://github.com/marcocecca00/recas-containers-docs/tree/master/templates/Es4_build_and_run_geant_example"><code>Es4_build_and_run_geant_example</code></a></li>
<li><a href="https://github.com/marcocecca00/recas-containers-docs/tree/master/templates/Es5_build_and_run_python"><code>Es5_build_and_run_python</code></a></li>
</ul>
<hr />
<h3 id="sec-esempio1">Esempio 1: test dell'immagine Geant4<a class="headerlink" href="#sec-esempio1" title="Permanent link">&para;</a></h3>
<p>Il primo esempio ha lo scopo di verificare che l’immagine <code>G4_v11.3.1.sif</code> funzioni correttamente su un worker node. L’obiettivo è sapere su quale nodo gira il job, quali versioni di Geant4, ROOT e Python sono visibili dall’interno del container e se l’ambiente è coerente.</p>
<p>Si inizia creando la directory del test e una sottocartella per i log:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-7-1">1</a></span>
<span class="normal"><a href="#__codelineno-7-2">2</a></span>
<span class="normal"><a href="#__codelineno-7-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="nb">cd</span><span class="w"> </span>/lustrehome/bob
<a id="__codelineno-7-2" name="__codelineno-7-2"></a>mkdir<span class="w"> </span>-p<span class="w"> </span>condor_tests/test_container/logs
<a id="__codelineno-7-3" name="__codelineno-7-3"></a><span class="nb">cd</span><span class="w"> </span>condor_tests/test_container
</code></pre></div></td></tr></table></div>
<p>Si crea un link all’immagine condivisa di <code>alice</code>:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-8-1">1</a></span>
<span class="normal"><a href="#__codelineno-8-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1"></a>ln<span class="w"> </span>-sf<span class="w"> </span>/lustrehome/alice/apptainer_images/G4_v11.3.1.sif<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="w">       </span>G4_v11.3.1.sif
</code></pre></div></td></tr></table></div>
<p>Lo script <code>test_container.sh</code>, che sarà eseguito dentro il container, può essere definito come segue:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-9-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-9-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-9-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-9-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-9-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-9-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-9-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-9-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-9-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-9-10">10</a></span>
<span class="normal"><a href="#__codelineno-9-11">11</a></span>
<span class="normal"><a href="#__codelineno-9-12">12</a></span>
<span class="normal"><a href="#__codelineno-9-13">13</a></span>
<span class="normal"><a href="#__codelineno-9-14">14</a></span>
<span class="normal"><a href="#__codelineno-9-15">15</a></span>
<span class="normal"><a href="#__codelineno-9-16">16</a></span>
<span class="normal"><a href="#__codelineno-9-17">17</a></span>
<span class="normal"><a href="#__codelineno-9-18">18</a></span>
<span class="normal"><a href="#__codelineno-9-19">19</a></span>
<span class="normal"><a href="#__codelineno-9-20">20</a></span>
<span class="normal"><a href="#__codelineno-9-21">21</a></span>
<span class="normal"><a href="#__codelineno-9-22">22</a></span>
<span class="normal"><a href="#__codelineno-9-23">23</a></span>
<span class="normal"><a href="#__codelineno-9-24">24</a></span>
<span class="normal"><a href="#__codelineno-9-25">25</a></span>
<span class="normal"><a href="#__codelineno-9-26">26</a></span>
<span class="normal"><a href="#__codelineno-9-27">27</a></span>
<span class="normal"><a href="#__codelineno-9-28">28</a></span>
<span class="normal"><a href="#__codelineno-9-29">29</a></span>
<span class="normal"><a href="#__codelineno-9-30">30</a></span>
<span class="normal"><a href="#__codelineno-9-31">31</a></span>
<span class="normal"><a href="#__codelineno-9-32">32</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="ch">#!/bin/bash</span>
<a id="__codelineno-9-2" name="__codelineno-9-2"></a><span class="nb">set</span><span class="w"> </span>-euo<span class="w"> </span>pipefail
<a id="__codelineno-9-3" name="__codelineno-9-3"></a>
<a id="__codelineno-9-4" name="__codelineno-9-4"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[TEST] Start: </span><span class="k">$(</span>date<span class="k">)</span><span class="s2">&quot;</span>
<a id="__codelineno-9-5" name="__codelineno-9-5"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[TEST] Host:  </span><span class="k">$(</span>hostname<span class="k">)</span><span class="s2">&quot;</span>
<a id="__codelineno-9-6" name="__codelineno-9-6"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[TEST] User:  </span><span class="k">$(</span>whoami<span class="k">)</span><span class="s2">&quot;</span>
<a id="__codelineno-9-7" name="__codelineno-9-7"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[TEST] Pwd:   </span><span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span><span class="s2">&quot;</span>
<a id="__codelineno-9-8" name="__codelineno-9-8"></a><span class="nb">echo</span>
<a id="__codelineno-9-9" name="__codelineno-9-9"></a>
<a id="__codelineno-9-10" name="__codelineno-9-10"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[TEST] Environment snippet:&quot;</span>
<a id="__codelineno-9-11" name="__codelineno-9-11"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;  G4INSTALL=</span><span class="si">${</span><span class="nv">G4INSTALL</span><span class="k">:-</span><span class="nv">undefined</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-9-12" name="__codelineno-9-12"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;  G4VERSION=</span><span class="si">${</span><span class="nv">G4VERSION</span><span class="k">:-</span><span class="nv">undefined</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-9-13" name="__codelineno-9-13"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;  ROOTSYS=</span><span class="si">${</span><span class="nv">ROOTSYS</span><span class="k">:-</span><span class="nv">undefined</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-9-14" name="__codelineno-9-14"></a><span class="nb">echo</span>
<a id="__codelineno-9-15" name="__codelineno-9-15"></a>
<a id="__codelineno-9-16" name="__codelineno-9-16"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[TEST] Checking Geant4 / ROOT / Python...&quot;</span>
<a id="__codelineno-9-17" name="__codelineno-9-17"></a><span class="nb">command</span><span class="w"> </span>-v<span class="w"> </span>geant4-config<span class="w">  </span>&gt;/dev/null<span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-9-18" name="__codelineno-9-18"></a><span class="w">  </span>geant4-config<span class="w"> </span>--version<span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;geant4-config NOT found&quot;</span>
<a id="__codelineno-9-19" name="__codelineno-9-19"></a><span class="nb">command</span><span class="w"> </span>-v<span class="w"> </span>root-config<span class="w">    </span>&gt;/dev/null<span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-9-20" name="__codelineno-9-20"></a><span class="w">  </span>root-config<span class="w"> </span>--version<span class="w">   </span><span class="o">||</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;root-config NOT found&quot;</span>
<a id="__codelineno-9-21" name="__codelineno-9-21"></a><span class="nb">command</span><span class="w"> </span>-v<span class="w"> </span>python3<span class="w">        </span>&gt;/dev/null<span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-9-22" name="__codelineno-9-22"></a><span class="w">  </span>python3<span class="w"> </span>--version<span class="w">       </span><span class="o">||</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;python3 NOT found&quot;</span>
<a id="__codelineno-9-23" name="__codelineno-9-23"></a><span class="nb">echo</span>
<a id="__codelineno-9-24" name="__codelineno-9-24"></a>
<a id="__codelineno-9-25" name="__codelineno-9-25"></a>python3<span class="w"> </span>-<span class="w"> </span><span class="s">&lt;&lt; &#39;EOF&#39;</span>
<a id="__codelineno-9-26" name="__codelineno-9-26"></a><span class="s">import sys, platform</span>
<a id="__codelineno-9-27" name="__codelineno-9-27"></a><span class="s">print(&quot;Python:&quot;, sys.version.split()[0])</span>
<a id="__codelineno-9-28" name="__codelineno-9-28"></a><span class="s">print(&quot;Platform:&quot;, platform.platform())</span>
<a id="__codelineno-9-29" name="__codelineno-9-29"></a><span class="s">EOF</span>
<a id="__codelineno-9-30" name="__codelineno-9-30"></a>
<a id="__codelineno-9-31" name="__codelineno-9-31"></a><span class="nb">echo</span>
<a id="__codelineno-9-32" name="__codelineno-9-32"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[TEST] Done: </span><span class="k">$(</span>date<span class="k">)</span><span class="s2">&quot;</span>
</code></pre></div></td></tr></table></div>
<p>Lo script va reso eseguibile:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-10-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1"></a>chmod<span class="w"> </span>+x<span class="w"> </span>test_container.sh
</code></pre></div></td></tr></table></div>
<p>Il file di submit <code>test_container.csi</code> specifica la directory iniziale, lo script da eseguire e l’immagine da usare:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-11-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-11-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-11-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-11-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-11-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-11-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-11-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-11-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-11-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-11-10">10</a></span>
<span class="normal"><a href="#__codelineno-11-11">11</a></span>
<span class="normal"><a href="#__codelineno-11-12">12</a></span>
<span class="normal"><a href="#__codelineno-11-13">13</a></span>
<span class="normal"><a href="#__codelineno-11-14">14</a></span>
<span class="normal"><a href="#__codelineno-11-15">15</a></span>
<span class="normal"><a href="#__codelineno-11-16">16</a></span>
<span class="normal"><a href="#__codelineno-11-17">17</a></span>
<span class="normal"><a href="#__codelineno-11-18">18</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="nv">universe</span><span class="w">        </span><span class="o">=</span><span class="w"> </span>vanilla
<a id="__codelineno-11-2" name="__codelineno-11-2"></a>
<a id="__codelineno-11-3" name="__codelineno-11-3"></a><span class="nv">initialdir</span><span class="w">      </span><span class="o">=</span><span class="w"> </span>/lustrehome/bob/condor_tests/test_container
<a id="__codelineno-11-4" name="__codelineno-11-4"></a>
<a id="__codelineno-11-5" name="__codelineno-11-5"></a><span class="nv">executable</span><span class="w">      </span><span class="o">=</span><span class="w"> </span>test_container.sh
<a id="__codelineno-11-6" name="__codelineno-11-6"></a><span class="nv">arguments</span><span class="w">       </span><span class="o">=</span>
<a id="__codelineno-11-7" name="__codelineno-11-7"></a>
<a id="__codelineno-11-8" name="__codelineno-11-8"></a><span class="nv">container_image</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>G4_v11.3.1.sif
<a id="__codelineno-11-9" name="__codelineno-11-9"></a>
<a id="__codelineno-11-10" name="__codelineno-11-10"></a><span class="nv">request_cpus</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="m">1</span>
<a id="__codelineno-11-11" name="__codelineno-11-11"></a><span class="nv">request_memory</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>GB
<a id="__codelineno-11-12" name="__codelineno-11-12"></a><span class="nv">request_disk</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="m">4</span><span class="w"> </span>GB
<a id="__codelineno-11-13" name="__codelineno-11-13"></a>
<a id="__codelineno-11-14" name="__codelineno-11-14"></a><span class="nv">output</span><span class="w">          </span><span class="o">=</span><span class="w"> </span>logs/test_<span class="k">$(</span>ClusterId<span class="k">)</span>.<span class="k">$(</span>ProcId<span class="k">)</span>.out
<a id="__codelineno-11-15" name="__codelineno-11-15"></a><span class="nv">error</span><span class="w">           </span><span class="o">=</span><span class="w"> </span>logs/test_<span class="k">$(</span>ClusterId<span class="k">)</span>.<span class="k">$(</span>ProcId<span class="k">)</span>.err
<a id="__codelineno-11-16" name="__codelineno-11-16"></a><span class="nv">log</span><span class="w">             </span><span class="o">=</span><span class="w"> </span>logs/test_<span class="k">$(</span>ClusterId<span class="k">)</span>.<span class="k">$(</span>ProcId<span class="k">)</span>.log
<a id="__codelineno-11-17" name="__codelineno-11-17"></a>
<a id="__codelineno-11-18" name="__codelineno-11-18"></a>queue<span class="w"> </span><span class="m">1</span>
</code></pre></div></td></tr></table></div>
<p>La sottomissione avviene con:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-12-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1"></a>condor_submit<span class="w"> </span>test_container.csi
</code></pre></div></td></tr></table></div>
<p>Quando il job è completato, il file <code>logs/test_...out</code> contiene le informazioni stampate dallo script: il nome del worker node, l’utente, la directory di lavoro, le variabili di ambiente e le versioni dei software principali. Questo conferma che l’immagine è correttamente utilizzabile con HTCondor secondo lo schema introdotto in <a href="#sec-concetti-base">Concetti di base: container, Apptainer e HTCondor</a>.</p>
<div class="admonition warning">
<p class="admonition-title"> Job in HOLD: controlli rapidi</p>
<p>Se il job va in stato <strong>HOLD</strong> subito dopo la sottomissione, controllare:</p>
<ul>
<li>
<p><strong>Symlink alla <code>.sif</code></strong><br />
  Verificare che il link non sia rotto:
  <div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-13-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1"></a>ls<span class="w"> </span>-l<span class="w"> </span>G4_v11.3.1.sif
</code></pre></div></td></tr></table></div>
  Deve puntare a <code>/lustrehome/alice/apptainer_images/G4_v11.3.1.sif</code> (o percorso equivalente).</p>
</li>
<li>
<p><strong>Esistenza e permessi dell’immagine reale</strong><br />
  Controllare che il file reale esista e sia leggibile:
  <div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-14-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1"></a>ls<span class="w"> </span>-l<span class="w"> </span>/lustrehome/alice/apptainer_images/G4_v11.3.1.sif
</code></pre></div></td></tr></table></div></p>
</li>
<li>
<p><strong>Coerenza del nome in <code>container_image</code></strong><br />
  Nel file di submit, il valore di:
  <div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-15-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1"></a>container_image = G4_v11.3.1.sif
</code></pre></div></td></tr></table></div>
  deve coincidere esattamente con il nome del file presente nella <code>initialdir</code>.</p>
</li>
<li>
<p><strong>Percorso corretto di <code>initialdir</code></strong><br />
  Verificare che la directory indicata da <code>initialdir</code> esista e contenga sia
  lo script <code>executable</code> sia il symlink all’immagine.</p>
</li>
</ul>
</div>
<hr />
<h3 id="sec-esempio2">Esempio 2: build dell’esempio B5 di Geant4<a class="headerlink" href="#sec-esempio2" title="Permanent link">&para;</a></h3>
<p>Il secondo esempio mostra come compilare l’esempio B5 di Geant4 usando l’immagine <code>G4_v11.3.1.sif</code>. L’obiettivo è ottenere l’eseguibile <code>exampleB5</code> in una directory di build gestita dal job.</p>
<p>Si crea la directory del test di build:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-16-1">1</a></span>
<span class="normal"><a href="#__codelineno-16-2">2</a></span>
<span class="normal"><a href="#__codelineno-16-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1"></a><span class="nb">cd</span><span class="w"> </span>/lustrehome/bob
<a id="__codelineno-16-2" name="__codelineno-16-2"></a>mkdir<span class="w"> </span>-p<span class="w"> </span>condor_tests/build_B5_11.3.1/logs
<a id="__codelineno-16-3" name="__codelineno-16-3"></a><span class="nb">cd</span><span class="w"> </span>condor_tests/build_B5_11.3.1
</code></pre></div></td></tr></table></div>
<p>Si collega l’immagine condivisa:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-17-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1"></a>ln<span class="w"> </span>-sf<span class="w"> </span>/lustrehome/alice/apptainer_images/G4_v11.3.1.sif<span class="w"> </span>G4_v11.3.1.sif
</code></pre></div></td></tr></table></div>
<p>Lo script <code>build_B5_exec.sh</code> viene eseguito dentro il container e si occupa di configurare e compilare il progetto:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-18-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-18-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-18-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-18-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-18-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-18-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-18-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-18-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-18-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-18-10">10</a></span>
<span class="normal"><a href="#__codelineno-18-11">11</a></span>
<span class="normal"><a href="#__codelineno-18-12">12</a></span>
<span class="normal"><a href="#__codelineno-18-13">13</a></span>
<span class="normal"><a href="#__codelineno-18-14">14</a></span>
<span class="normal"><a href="#__codelineno-18-15">15</a></span>
<span class="normal"><a href="#__codelineno-18-16">16</a></span>
<span class="normal"><a href="#__codelineno-18-17">17</a></span>
<span class="normal"><a href="#__codelineno-18-18">18</a></span>
<span class="normal"><a href="#__codelineno-18-19">19</a></span>
<span class="normal"><a href="#__codelineno-18-20">20</a></span>
<span class="normal"><a href="#__codelineno-18-21">21</a></span>
<span class="normal"><a href="#__codelineno-18-22">22</a></span>
<span class="normal"><a href="#__codelineno-18-23">23</a></span>
<span class="normal"><a href="#__codelineno-18-24">24</a></span>
<span class="normal"><a href="#__codelineno-18-25">25</a></span>
<span class="normal"><a href="#__codelineno-18-26">26</a></span>
<span class="normal"><a href="#__codelineno-18-27">27</a></span>
<span class="normal"><a href="#__codelineno-18-28">28</a></span>
<span class="normal"><a href="#__codelineno-18-29">29</a></span>
<span class="normal"><a href="#__codelineno-18-30">30</a></span>
<span class="normal"><a href="#__codelineno-18-31">31</a></span>
<span class="normal"><a href="#__codelineno-18-32">32</a></span>
<span class="normal"><a href="#__codelineno-18-33">33</a></span>
<span class="normal"><a href="#__codelineno-18-34">34</a></span>
<span class="normal"><a href="#__codelineno-18-35">35</a></span>
<span class="normal"><a href="#__codelineno-18-36">36</a></span>
<span class="normal"><a href="#__codelineno-18-37">37</a></span>
<span class="normal"><a href="#__codelineno-18-38">38</a></span>
<span class="normal"><a href="#__codelineno-18-39">39</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1"></a><span class="ch">#!/bin/bash</span>
<a id="__codelineno-18-2" name="__codelineno-18-2"></a><span class="nb">set</span><span class="w"> </span>-euo<span class="w"> </span>pipefail
<a id="__codelineno-18-3" name="__codelineno-18-3"></a>
<a id="__codelineno-18-4" name="__codelineno-18-4"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[BUILD] Start: </span><span class="k">$(</span>date<span class="k">)</span><span class="s2">&quot;</span>
<a id="__codelineno-18-5" name="__codelineno-18-5"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[BUILD] Host:  </span><span class="k">$(</span>hostname<span class="k">)</span><span class="s2">&quot;</span>
<a id="__codelineno-18-6" name="__codelineno-18-6"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[BUILD] User:  </span><span class="k">$(</span>whoami<span class="k">)</span><span class="s2">&quot;</span>
<a id="__codelineno-18-7" name="__codelineno-18-7"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[BUILD] Pwd:   </span><span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span><span class="s2">&quot;</span>
<a id="__codelineno-18-8" name="__codelineno-18-8"></a><span class="nb">echo</span>
<a id="__codelineno-18-9" name="__codelineno-18-9"></a>
<a id="__codelineno-18-10" name="__codelineno-18-10"></a><span class="nv">SRC_DIR</span><span class="o">=</span><span class="s2">&quot;/opt/geant4/share/Geant4/examples/basic/B5&quot;</span>
<a id="__codelineno-18-11" name="__codelineno-18-11"></a><span class="nv">BUILD_DIR</span><span class="o">=</span><span class="s2">&quot;B5_build_condor&quot;</span>
<a id="__codelineno-18-12" name="__codelineno-18-12"></a>
<a id="__codelineno-18-13" name="__codelineno-18-13"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[BUILD] SRC_DIR   = </span><span class="si">${</span><span class="nv">SRC_DIR</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-18-14" name="__codelineno-18-14"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[BUILD] BUILD_DIR = </span><span class="si">${</span><span class="nv">BUILD_DIR</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-18-15" name="__codelineno-18-15"></a><span class="nb">echo</span>
<a id="__codelineno-18-16" name="__codelineno-18-16"></a>
<a id="__codelineno-18-17" name="__codelineno-18-17"></a><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span>-f<span class="w"> </span>/opt/geant4/bin/geant4.sh<span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<a id="__codelineno-18-18" name="__codelineno-18-18"></a><span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[BUILD] Sourcing Geant4...&quot;</span>
<a id="__codelineno-18-19" name="__codelineno-18-19"></a><span class="w">  </span><span class="nb">source</span><span class="w"> </span>/opt/geant4/bin/geant4.sh
<a id="__codelineno-18-20" name="__codelineno-18-20"></a><span class="k">fi</span>
<a id="__codelineno-18-21" name="__codelineno-18-21"></a>
<a id="__codelineno-18-22" name="__codelineno-18-22"></a><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span>-f<span class="w"> </span>/opt/root/bin/thisroot.sh<span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<a id="__codelineno-18-23" name="__codelineno-18-23"></a><span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[BUILD] Sourcing ROOT...&quot;</span>
<a id="__codelineno-18-24" name="__codelineno-18-24"></a><span class="w">  </span><span class="nb">source</span><span class="w"> </span>/opt/root/bin/thisroot.sh
<a id="__codelineno-18-25" name="__codelineno-18-25"></a><span class="k">fi</span>
<a id="__codelineno-18-26" name="__codelineno-18-26"></a>
<a id="__codelineno-18-27" name="__codelineno-18-27"></a>mkdir<span class="w"> </span>-p<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">BUILD_DIR</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-18-28" name="__codelineno-18-28"></a><span class="nb">cd</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">BUILD_DIR</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-18-29" name="__codelineno-18-29"></a>
<a id="__codelineno-18-30" name="__codelineno-18-30"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[BUILD] Now in: </span><span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span><span class="s2">&quot;</span>
<a id="__codelineno-18-31" name="__codelineno-18-31"></a>
<a id="__codelineno-18-32" name="__codelineno-18-32"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[BUILD] Running CMake...&quot;</span>
<a id="__codelineno-18-33" name="__codelineno-18-33"></a>cmake<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">SRC_DIR</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-18-34" name="__codelineno-18-34"></a>
<a id="__codelineno-18-35" name="__codelineno-18-35"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[BUILD] Building...&quot;</span>
<a id="__codelineno-18-36" name="__codelineno-18-36"></a>cmake<span class="w"> </span>--build<span class="w"> </span>.<span class="w"> </span>--<span class="w"> </span>-j<span class="s2">&quot;</span><span class="k">$(</span>nproc<span class="k">)</span><span class="s2">&quot;</span>
<a id="__codelineno-18-37" name="__codelineno-18-37"></a>
<a id="__codelineno-18-38" name="__codelineno-18-38"></a><span class="nb">echo</span>
<a id="__codelineno-18-39" name="__codelineno-18-39"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[BUILD] Done: </span><span class="k">$(</span>date<span class="k">)</span><span class="s2">&quot;</span>
</code></pre></div></td></tr></table></div>
<p>Lo script viene reso eseguibile:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-19-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1"></a>chmod<span class="w"> </span>+x<span class="w"> </span>build_B5_exec.sh
</code></pre></div></td></tr></table></div>
<p>Il file di submit <code>build_B5_11.3.1.csi</code> è:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-20-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-20-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-20-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-20-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-20-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-20-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-20-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-20-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-20-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-20-10">10</a></span>
<span class="normal"><a href="#__codelineno-20-11">11</a></span>
<span class="normal"><a href="#__codelineno-20-12">12</a></span>
<span class="normal"><a href="#__codelineno-20-13">13</a></span>
<span class="normal"><a href="#__codelineno-20-14">14</a></span>
<span class="normal"><a href="#__codelineno-20-15">15</a></span>
<span class="normal"><a href="#__codelineno-20-16">16</a></span>
<span class="normal"><a href="#__codelineno-20-17">17</a></span>
<span class="normal"><a href="#__codelineno-20-18">18</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1"></a><span class="nv">universe</span><span class="w">        </span><span class="o">=</span><span class="w"> </span>vanilla
<a id="__codelineno-20-2" name="__codelineno-20-2"></a>
<a id="__codelineno-20-3" name="__codelineno-20-3"></a><span class="nv">initialdir</span><span class="w">      </span><span class="o">=</span><span class="w"> </span>/lustrehome/bob/condor_tests/build_B5_11.3.1
<a id="__codelineno-20-4" name="__codelineno-20-4"></a>
<a id="__codelineno-20-5" name="__codelineno-20-5"></a><span class="nv">executable</span><span class="w">      </span><span class="o">=</span><span class="w"> </span>build_B5_exec.sh
<a id="__codelineno-20-6" name="__codelineno-20-6"></a><span class="nv">arguments</span><span class="w">       </span><span class="o">=</span>
<a id="__codelineno-20-7" name="__codelineno-20-7"></a>
<a id="__codelineno-20-8" name="__codelineno-20-8"></a><span class="nv">container_image</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>G4_v11.3.1.sif
<a id="__codelineno-20-9" name="__codelineno-20-9"></a>
<a id="__codelineno-20-10" name="__codelineno-20-10"></a><span class="nv">request_cpus</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="m">4</span>
<a id="__codelineno-20-11" name="__codelineno-20-11"></a><span class="nv">request_memory</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="m">4</span><span class="w"> </span>GB
<a id="__codelineno-20-12" name="__codelineno-20-12"></a><span class="nv">request_disk</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="m">8</span><span class="w"> </span>GB
<a id="__codelineno-20-13" name="__codelineno-20-13"></a>
<a id="__codelineno-20-14" name="__codelineno-20-14"></a><span class="nv">output</span><span class="w">          </span><span class="o">=</span><span class="w"> </span>logs/build_<span class="k">$(</span>ClusterId<span class="k">)</span>.<span class="k">$(</span>ProcId<span class="k">)</span>.out
<a id="__codelineno-20-15" name="__codelineno-20-15"></a><span class="nv">error</span><span class="w">           </span><span class="o">=</span><span class="w"> </span>logs/build_<span class="k">$(</span>ClusterId<span class="k">)</span>.<span class="k">$(</span>ProcId<span class="k">)</span>.err
<a id="__codelineno-20-16" name="__codelineno-20-16"></a><span class="nv">log</span><span class="w">             </span><span class="o">=</span><span class="w"> </span>logs/build_<span class="k">$(</span>ClusterId<span class="k">)</span>.<span class="k">$(</span>ProcId<span class="k">)</span>.log
<a id="__codelineno-20-17" name="__codelineno-20-17"></a>
<a id="__codelineno-20-18" name="__codelineno-20-18"></a>queue<span class="w"> </span><span class="m">1</span>
</code></pre></div></td></tr></table></div>
<p>Il job si sottomette con:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-21-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1"></a>condor_submit<span class="w"> </span>build_B5_11.3.1.csi
</code></pre></div></td></tr></table></div>
<p>Al termine della compilazione, nella directory <code>/lustrehome/bob/condor_tests/build_B5_11.3.1/B5_build_condor</code> si trovano i file di CMake e l’eseguibile <code>exampleB5</code>. Lo standard output del job contiene i messaggi di CMake e l’esito del build, che verrà riutilizzato nella sezione <a href="#sec-esempio3">Esempio 3: run dell’esempio B5</a>.</p>
<hr />
<h3 id="sec-esempio3">Esempio 3: run dell’esempio B5<a class="headerlink" href="#sec-esempio3" title="Permanent link">&para;</a></h3>
<p>Il terzo esempio riutilizza l’eseguibile <code>exampleB5</code> compilato in <a href="#sec-esempio2">Esempio 2: build dell’esempio B5 di Geant4</a> e mostra come preparare una directory di run separata, in cui copiare l’eseguibile e le macro e lanciare la simulazione.</p>
<p>Si crea la directory per il run:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-22-1">1</a></span>
<span class="normal"><a href="#__codelineno-22-2">2</a></span>
<span class="normal"><a href="#__codelineno-22-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1"></a><span class="nb">cd</span><span class="w"> </span>/lustrehome/bob
<a id="__codelineno-22-2" name="__codelineno-22-2"></a>mkdir<span class="w"> </span>-p<span class="w"> </span>condor_tests/run_B5_11.3.1/logs
<a id="__codelineno-22-3" name="__codelineno-22-3"></a><span class="nb">cd</span><span class="w"> </span>condor_tests/run_B5_11.3.1
</code></pre></div></td></tr></table></div>
<p>Si collega l’immagine:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-23-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1"></a>ln<span class="w"> </span>-sf<span class="w"> </span>/lustrehome/alice/apptainer_images/G4_v11.3.1.sif<span class="w"> </span>G4_v11.3.1.sif
</code></pre></div></td></tr></table></div>
<p>Si copiano l’eseguibile e la macro <code>run1.mac</code> dalla build:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-24-1">1</a></span>
<span class="normal"><a href="#__codelineno-24-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1"></a>cp<span class="w"> </span>/lustrehome/bob/condor_tests/build_B5_11.3.1/B5_build_condor/exampleB5<span class="w"> </span>.
<a id="__codelineno-24-2" name="__codelineno-24-2"></a>cp<span class="w"> </span>/lustrehome/bob/condor_tests/build_B5_11.3.1/B5_build_condor/run1.mac<span class="w"> </span>.
</code></pre></div></td></tr></table></div>
<p>Lo script <code>run_B5_exec.sh</code> lancia l’eseguibile con la macro:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-25-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-25-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-25-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-25-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-25-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-25-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-25-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-25-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-25-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-25-10">10</a></span>
<span class="normal"><a href="#__codelineno-25-11">11</a></span>
<span class="normal"><a href="#__codelineno-25-12">12</a></span>
<span class="normal"><a href="#__codelineno-25-13">13</a></span>
<span class="normal"><a href="#__codelineno-25-14">14</a></span>
<span class="normal"><a href="#__codelineno-25-15">15</a></span>
<span class="normal"><a href="#__codelineno-25-16">16</a></span>
<span class="normal"><a href="#__codelineno-25-17">17</a></span>
<span class="normal"><a href="#__codelineno-25-18">18</a></span>
<span class="normal"><a href="#__codelineno-25-19">19</a></span>
<span class="normal"><a href="#__codelineno-25-20">20</a></span>
<span class="normal"><a href="#__codelineno-25-21">21</a></span>
<span class="normal"><a href="#__codelineno-25-22">22</a></span>
<span class="normal"><a href="#__codelineno-25-23">23</a></span>
<span class="normal"><a href="#__codelineno-25-24">24</a></span>
<span class="normal"><a href="#__codelineno-25-25">25</a></span>
<span class="normal"><a href="#__codelineno-25-26">26</a></span>
<span class="normal"><a href="#__codelineno-25-27">27</a></span>
<span class="normal"><a href="#__codelineno-25-28">28</a></span>
<span class="normal"><a href="#__codelineno-25-29">29</a></span>
<span class="normal"><a href="#__codelineno-25-30">30</a></span>
<span class="normal"><a href="#__codelineno-25-31">31</a></span>
<span class="normal"><a href="#__codelineno-25-32">32</a></span>
<span class="normal"><a href="#__codelineno-25-33">33</a></span>
<span class="normal"><a href="#__codelineno-25-34">34</a></span>
<span class="normal"><a href="#__codelineno-25-35">35</a></span>
<span class="normal"><a href="#__codelineno-25-36">36</a></span>
<span class="normal"><a href="#__codelineno-25-37">37</a></span>
<span class="normal"><a href="#__codelineno-25-38">38</a></span>
<span class="normal"><a href="#__codelineno-25-39">39</a></span>
<span class="normal"><a href="#__codelineno-25-40">40</a></span>
<span class="normal"><a href="#__codelineno-25-41">41</a></span>
<span class="normal"><a href="#__codelineno-25-42">42</a></span>
<span class="normal"><a href="#__codelineno-25-43">43</a></span>
<span class="normal"><a href="#__codelineno-25-44">44</a></span>
<span class="normal"><a href="#__codelineno-25-45">45</a></span>
<span class="normal"><a href="#__codelineno-25-46">46</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1"></a><span class="ch">#!/bin/bash</span>
<a id="__codelineno-25-2" name="__codelineno-25-2"></a><span class="nb">set</span><span class="w"> </span>-euo<span class="w"> </span>pipefail
<a id="__codelineno-25-3" name="__codelineno-25-3"></a>
<a id="__codelineno-25-4" name="__codelineno-25-4"></a><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="nv">$#</span><span class="w"> </span>-lt<span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<a id="__codelineno-25-5" name="__codelineno-25-5"></a><span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Usage: </span><span class="nv">$0</span><span class="s2"> &lt;exec_rel_path&gt; &lt;macro_rel_path&gt;&quot;</span>
<a id="__codelineno-25-6" name="__codelineno-25-6"></a><span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Example: </span><span class="nv">$0</span><span class="s2"> exampleB5 run1.mac&quot;</span>
<a id="__codelineno-25-7" name="__codelineno-25-7"></a><span class="w">  </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<a id="__codelineno-25-8" name="__codelineno-25-8"></a><span class="k">fi</span>
<a id="__codelineno-25-9" name="__codelineno-25-9"></a>
<a id="__codelineno-25-10" name="__codelineno-25-10"></a><span class="nv">EXEC_REL</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
<a id="__codelineno-25-11" name="__codelineno-25-11"></a><span class="nv">MACRO_REL</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span>
<a id="__codelineno-25-12" name="__codelineno-25-12"></a>
<a id="__codelineno-25-13" name="__codelineno-25-13"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[RUN] Start: </span><span class="k">$(</span>date<span class="k">)</span><span class="s2">&quot;</span>
<a id="__codelineno-25-14" name="__codelineno-25-14"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[RUN] Host:  </span><span class="k">$(</span>hostname<span class="k">)</span><span class="s2">&quot;</span>
<a id="__codelineno-25-15" name="__codelineno-25-15"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[RUN] User:  </span><span class="k">$(</span>whoami<span class="k">)</span><span class="s2">&quot;</span>
<a id="__codelineno-25-16" name="__codelineno-25-16"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[RUN] Pwd:   </span><span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span><span class="s2">&quot;</span>
<a id="__codelineno-25-17" name="__codelineno-25-17"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[RUN] Exec:  </span><span class="si">${</span><span class="nv">EXEC_REL</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-25-18" name="__codelineno-25-18"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[RUN] Macro: </span><span class="si">${</span><span class="nv">MACRO_REL</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-25-19" name="__codelineno-25-19"></a><span class="nb">echo</span>
<a id="__codelineno-25-20" name="__codelineno-25-20"></a>
<a id="__codelineno-25-21" name="__codelineno-25-21"></a><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span>-f<span class="w"> </span>/opt/geant4/bin/geant4.sh<span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<a id="__codelineno-25-22" name="__codelineno-25-22"></a><span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[RUN] Sourcing Geant4...&quot;</span>
<a id="__codelineno-25-23" name="__codelineno-25-23"></a><span class="w">  </span><span class="nb">source</span><span class="w"> </span>/opt/geant4/bin/geant4.sh
<a id="__codelineno-25-24" name="__codelineno-25-24"></a><span class="k">fi</span>
<a id="__codelineno-25-25" name="__codelineno-25-25"></a><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span>-f<span class="w"> </span>/opt/root/bin/thisroot.sh<span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<a id="__codelineno-25-26" name="__codelineno-25-26"></a><span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[RUN] Sourcing ROOT...&quot;</span>
<a id="__codelineno-25-27" name="__codelineno-25-27"></a><span class="w">  </span><span class="nb">source</span><span class="w"> </span>/opt/root/bin/thisroot.sh
<a id="__codelineno-25-28" name="__codelineno-25-28"></a><span class="k">fi</span>
<a id="__codelineno-25-29" name="__codelineno-25-29"></a>
<a id="__codelineno-25-30" name="__codelineno-25-30"></a><span class="nv">EXEC_PATH</span><span class="o">=</span><span class="s2">&quot;./</span><span class="si">${</span><span class="nv">EXEC_REL</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-25-31" name="__codelineno-25-31"></a><span class="nv">MACRO_PATH</span><span class="o">=</span><span class="s2">&quot;./</span><span class="si">${</span><span class="nv">MACRO_REL</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-25-32" name="__codelineno-25-32"></a>
<a id="__codelineno-25-33" name="__codelineno-25-33"></a><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span>!<span class="w"> </span>-x<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">EXEC_PATH</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<a id="__codelineno-25-34" name="__codelineno-25-34"></a><span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[RUN] ERROR: executable not found or not executable: </span><span class="si">${</span><span class="nv">EXEC_PATH</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-25-35" name="__codelineno-25-35"></a><span class="w">  </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<a id="__codelineno-25-36" name="__codelineno-25-36"></a><span class="k">fi</span>
<a id="__codelineno-25-37" name="__codelineno-25-37"></a><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span>!<span class="w"> </span>-f<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">MACRO_PATH</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<a id="__codelineno-25-38" name="__codelineno-25-38"></a><span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[RUN] ERROR: macro not found: </span><span class="si">${</span><span class="nv">MACRO_PATH</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-25-39" name="__codelineno-25-39"></a><span class="w">  </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<a id="__codelineno-25-40" name="__codelineno-25-40"></a><span class="k">fi</span>
<a id="__codelineno-25-41" name="__codelineno-25-41"></a>
<a id="__codelineno-25-42" name="__codelineno-25-42"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[RUN] Launching: </span><span class="si">${</span><span class="nv">EXEC_PATH</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">MACRO_PATH</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-25-43" name="__codelineno-25-43"></a><span class="s2">&quot;</span><span class="si">${</span><span class="nv">EXEC_PATH</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">MACRO_PATH</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-25-44" name="__codelineno-25-44"></a>
<a id="__codelineno-25-45" name="__codelineno-25-45"></a><span class="nb">echo</span>
<a id="__codelineno-25-46" name="__codelineno-25-46"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[RUN] Done: </span><span class="k">$(</span>date<span class="k">)</span><span class="s2">&quot;</span>
</code></pre></div></td></tr></table></div>
<p>Lo script va reso eseguibile:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-26-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1"></a>chmod<span class="w"> </span>+x<span class="w"> </span>run_B5_exec.sh
</code></pre></div></td></tr></table></div>
<p>Il file di submit <code>run_B5_11.3.1.csi</code> utilizza lo script, l’immagine e specifica le risorse richieste:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-27-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-27-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-27-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-27-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-27-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-27-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-27-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-27-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-27-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-27-10">10</a></span>
<span class="normal"><a href="#__codelineno-27-11">11</a></span>
<span class="normal"><a href="#__codelineno-27-12">12</a></span>
<span class="normal"><a href="#__codelineno-27-13">13</a></span>
<span class="normal"><a href="#__codelineno-27-14">14</a></span>
<span class="normal"><a href="#__codelineno-27-15">15</a></span>
<span class="normal"><a href="#__codelineno-27-16">16</a></span>
<span class="normal"><a href="#__codelineno-27-17">17</a></span>
<span class="normal"><a href="#__codelineno-27-18">18</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1"></a><span class="nv">universe</span><span class="w">        </span><span class="o">=</span><span class="w"> </span>vanilla
<a id="__codelineno-27-2" name="__codelineno-27-2"></a>
<a id="__codelineno-27-3" name="__codelineno-27-3"></a><span class="nv">initialdir</span><span class="w">      </span><span class="o">=</span><span class="w"> </span>/lustrehome/bob/condor_tests/run_B5_11.3.1
<a id="__codelineno-27-4" name="__codelineno-27-4"></a>
<a id="__codelineno-27-5" name="__codelineno-27-5"></a><span class="nv">executable</span><span class="w">      </span><span class="o">=</span><span class="w"> </span>run_B5_exec.sh
<a id="__codelineno-27-6" name="__codelineno-27-6"></a><span class="nv">arguments</span><span class="w">       </span><span class="o">=</span><span class="w"> </span>exampleB5<span class="w"> </span>run1.mac
<a id="__codelineno-27-7" name="__codelineno-27-7"></a>
<a id="__codelineno-27-8" name="__codelineno-27-8"></a><span class="nv">container_image</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>G4_v11.3.1.sif
<a id="__codelineno-27-9" name="__codelineno-27-9"></a>
<a id="__codelineno-27-10" name="__codelineno-27-10"></a><span class="nv">request_cpus</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="m">1</span>
<a id="__codelineno-27-11" name="__codelineno-27-11"></a><span class="nv">request_memory</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="w"> </span>GB
<a id="__codelineno-27-12" name="__codelineno-27-12"></a><span class="nv">request_disk</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="m">4</span><span class="w"> </span>GB
<a id="__codelineno-27-13" name="__codelineno-27-13"></a>
<a id="__codelineno-27-14" name="__codelineno-27-14"></a><span class="nv">output</span><span class="w">          </span><span class="o">=</span><span class="w"> </span>logs/run_<span class="k">$(</span>ClusterId<span class="k">)</span>.<span class="k">$(</span>ProcId<span class="k">)</span>.out
<a id="__codelineno-27-15" name="__codelineno-27-15"></a><span class="nv">error</span><span class="w">           </span><span class="o">=</span><span class="w"> </span>logs/run_<span class="k">$(</span>ClusterId<span class="k">)</span>.<span class="k">$(</span>ProcId<span class="k">)</span>.err
<a id="__codelineno-27-16" name="__codelineno-27-16"></a><span class="nv">log</span><span class="w">             </span><span class="o">=</span><span class="w"> </span>logs/run_<span class="k">$(</span>ClusterId<span class="k">)</span>.<span class="k">$(</span>ProcId<span class="k">)</span>.log
<a id="__codelineno-27-17" name="__codelineno-27-17"></a>
<a id="__codelineno-27-18" name="__codelineno-27-18"></a>queue<span class="w"> </span><span class="m">1</span>
</code></pre></div></td></tr></table></div>
<p>La sottomissione avviene come nei casi precedenti:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-28-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1"></a>condor_submit<span class="w"> </span>run_B5_11.3.1.csi
</code></pre></div></td></tr></table></div>
<p>Gli output prodotti da B5 vengono scritti nella directory <code>/lustrehome/bob/condor_tests/run_B5_11.3.1</code>, che corrisponde alla directory di lavoro del job dentro il container, e rimangono quindi disponibili all’utente anche dopo la fine dell’esecuzione.</p>
<hr />
<h3 id="sec-esempio4">Esempio 4: build e run di B5 in un unico job<a class="headerlink" href="#sec-esempio4" title="Permanent link">&para;</a></h3>
<p>In alcune situazioni è comodo compilare il codice e far partire subito il run all’interno dello stesso job Condor. Questo permette di avere un singolo file di submit per l’intera catena e di garantire che il run utilizzi esattamente la build prodotta nel job.</p>
<p>Per questo esempio si crea una nuova directory:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-29-1">1</a></span>
<span class="normal"><a href="#__codelineno-29-2">2</a></span>
<span class="normal"><a href="#__codelineno-29-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1"></a><span class="nb">cd</span><span class="w"> </span>/lustrehome/bob
<a id="__codelineno-29-2" name="__codelineno-29-2"></a>mkdir<span class="w"> </span>-p<span class="w"> </span>condor_tests/build_run_B5_11.3.1/logs
<a id="__codelineno-29-3" name="__codelineno-29-3"></a><span class="nb">cd</span><span class="w"> </span>condor_tests/build_run_B5_11.3.1
</code></pre></div></td></tr></table></div>
<p>Si collega l’immagine Geant4 11.3.1:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-30-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1"></a>ln<span class="w"> </span>-sf<span class="w"> </span>/lustrehome/alice/apptainer_images/G4_v11.3.1.sif<span class="w"> </span>G4_v11.3.1.sif
</code></pre></div></td></tr></table></div>
<p>Lo script <code>build_run_B5_exec.sh</code> esegue prima la compilazione dell’esempio B5 e subito dopo l’eseguibile con una macro di esempio:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-31-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-31-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-31-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-31-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-31-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-31-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-31-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-31-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-31-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-31-10">10</a></span>
<span class="normal"><a href="#__codelineno-31-11">11</a></span>
<span class="normal"><a href="#__codelineno-31-12">12</a></span>
<span class="normal"><a href="#__codelineno-31-13">13</a></span>
<span class="normal"><a href="#__codelineno-31-14">14</a></span>
<span class="normal"><a href="#__codelineno-31-15">15</a></span>
<span class="normal"><a href="#__codelineno-31-16">16</a></span>
<span class="normal"><a href="#__codelineno-31-17">17</a></span>
<span class="normal"><a href="#__codelineno-31-18">18</a></span>
<span class="normal"><a href="#__codelineno-31-19">19</a></span>
<span class="normal"><a href="#__codelineno-31-20">20</a></span>
<span class="normal"><a href="#__codelineno-31-21">21</a></span>
<span class="normal"><a href="#__codelineno-31-22">22</a></span>
<span class="normal"><a href="#__codelineno-31-23">23</a></span>
<span class="normal"><a href="#__codelineno-31-24">24</a></span>
<span class="normal"><a href="#__codelineno-31-25">25</a></span>
<span class="normal"><a href="#__codelineno-31-26">26</a></span>
<span class="normal"><a href="#__codelineno-31-27">27</a></span>
<span class="normal"><a href="#__codelineno-31-28">28</a></span>
<span class="normal"><a href="#__codelineno-31-29">29</a></span>
<span class="normal"><a href="#__codelineno-31-30">30</a></span>
<span class="normal"><a href="#__codelineno-31-31">31</a></span>
<span class="normal"><a href="#__codelineno-31-32">32</a></span>
<span class="normal"><a href="#__codelineno-31-33">33</a></span>
<span class="normal"><a href="#__codelineno-31-34">34</a></span>
<span class="normal"><a href="#__codelineno-31-35">35</a></span>
<span class="normal"><a href="#__codelineno-31-36">36</a></span>
<span class="normal"><a href="#__codelineno-31-37">37</a></span>
<span class="normal"><a href="#__codelineno-31-38">38</a></span>
<span class="normal"><a href="#__codelineno-31-39">39</a></span>
<span class="normal"><a href="#__codelineno-31-40">40</a></span>
<span class="normal"><a href="#__codelineno-31-41">41</a></span>
<span class="normal"><a href="#__codelineno-31-42">42</a></span>
<span class="normal"><a href="#__codelineno-31-43">43</a></span>
<span class="normal"><a href="#__codelineno-31-44">44</a></span>
<span class="normal"><a href="#__codelineno-31-45">45</a></span>
<span class="normal"><a href="#__codelineno-31-46">46</a></span>
<span class="normal"><a href="#__codelineno-31-47">47</a></span>
<span class="normal"><a href="#__codelineno-31-48">48</a></span>
<span class="normal"><a href="#__codelineno-31-49">49</a></span>
<span class="normal"><a href="#__codelineno-31-50">50</a></span>
<span class="normal"><a href="#__codelineno-31-51">51</a></span>
<span class="normal"><a href="#__codelineno-31-52">52</a></span>
<span class="normal"><a href="#__codelineno-31-53">53</a></span>
<span class="normal"><a href="#__codelineno-31-54">54</a></span>
<span class="normal"><a href="#__codelineno-31-55">55</a></span>
<span class="normal"><a href="#__codelineno-31-56">56</a></span>
<span class="normal"><a href="#__codelineno-31-57">57</a></span>
<span class="normal"><a href="#__codelineno-31-58">58</a></span>
<span class="normal"><a href="#__codelineno-31-59">59</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1"></a><span class="ch">#!/bin/bash</span>
<a id="__codelineno-31-2" name="__codelineno-31-2"></a><span class="nb">set</span><span class="w"> </span>-euo<span class="w"> </span>pipefail
<a id="__codelineno-31-3" name="__codelineno-31-3"></a>
<a id="__codelineno-31-4" name="__codelineno-31-4"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[BUILD+RUN] Start: </span><span class="k">$(</span>date<span class="k">)</span><span class="s2">&quot;</span>
<a id="__codelineno-31-5" name="__codelineno-31-5"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[BUILD+RUN] Host:  </span><span class="k">$(</span>hostname<span class="k">)</span><span class="s2">&quot;</span>
<a id="__codelineno-31-6" name="__codelineno-31-6"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[BUILD+RUN] User:  </span><span class="k">$(</span>whoami<span class="k">)</span><span class="s2">&quot;</span>
<a id="__codelineno-31-7" name="__codelineno-31-7"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[BUILD+RUN] Pwd:   </span><span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span><span class="s2">&quot;</span>
<a id="__codelineno-31-8" name="__codelineno-31-8"></a><span class="nb">echo</span>
<a id="__codelineno-31-9" name="__codelineno-31-9"></a>
<a id="__codelineno-31-10" name="__codelineno-31-10"></a><span class="nv">SRC_DIR</span><span class="o">=</span><span class="s2">&quot;/opt/geant4/share/Geant4/examples/basic/B5&quot;</span>
<a id="__codelineno-31-11" name="__codelineno-31-11"></a><span class="nv">BUILD_DIR</span><span class="o">=</span><span class="s2">&quot;B5_build_condor&quot;</span>
<a id="__codelineno-31-12" name="__codelineno-31-12"></a><span class="nv">MACRO</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">SRC_DIR</span><span class="si">}</span><span class="s2">/run1.mac&quot;</span>
<a id="__codelineno-31-13" name="__codelineno-31-13"></a>
<a id="__codelineno-31-14" name="__codelineno-31-14"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[BUILD+RUN] SRC_DIR   = </span><span class="si">${</span><span class="nv">SRC_DIR</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-31-15" name="__codelineno-31-15"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[BUILD+RUN] BUILD_DIR = </span><span class="si">${</span><span class="nv">BUILD_DIR</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-31-16" name="__codelineno-31-16"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[BUILD+RUN] MACRO     = </span><span class="si">${</span><span class="nv">MACRO</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-31-17" name="__codelineno-31-17"></a><span class="nb">echo</span>
<a id="__codelineno-31-18" name="__codelineno-31-18"></a>
<a id="__codelineno-31-19" name="__codelineno-31-19"></a><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span>-f<span class="w"> </span>/opt/geant4/bin/geant4.sh<span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<a id="__codelineno-31-20" name="__codelineno-31-20"></a><span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[BUILD+RUN] Sourcing Geant4...&quot;</span>
<a id="__codelineno-31-21" name="__codelineno-31-21"></a><span class="w">  </span><span class="nb">source</span><span class="w"> </span>/opt/geant4/bin/geant4.sh
<a id="__codelineno-31-22" name="__codelineno-31-22"></a><span class="k">fi</span>
<a id="__codelineno-31-23" name="__codelineno-31-23"></a>
<a id="__codelineno-31-24" name="__codelineno-31-24"></a><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span>-f<span class="w"> </span>/opt/root/bin/thisroot.sh<span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<a id="__codelineno-31-25" name="__codelineno-31-25"></a><span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[BUILD+RUN] Sourcing ROOT...&quot;</span>
<a id="__codelineno-31-26" name="__codelineno-31-26"></a><span class="w">  </span><span class="nb">source</span><span class="w"> </span>/opt/root/bin/thisroot.sh
<a id="__codelineno-31-27" name="__codelineno-31-27"></a><span class="k">fi</span>
<a id="__codelineno-31-28" name="__codelineno-31-28"></a>
<a id="__codelineno-31-29" name="__codelineno-31-29"></a>mkdir<span class="w"> </span>-p<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">BUILD_DIR</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-31-30" name="__codelineno-31-30"></a><span class="nb">cd</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">BUILD_DIR</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-31-31" name="__codelineno-31-31"></a>
<a id="__codelineno-31-32" name="__codelineno-31-32"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[BUILD+RUN] Now in: </span><span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span><span class="s2">&quot;</span>
<a id="__codelineno-31-33" name="__codelineno-31-33"></a>
<a id="__codelineno-31-34" name="__codelineno-31-34"></a><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span>-x<span class="w"> </span>exampleB5<span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<a id="__codelineno-31-35" name="__codelineno-31-35"></a><span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[BUILD+RUN] exampleB5 already built, skipping CMake/cmake --build.&quot;</span>
<a id="__codelineno-31-36" name="__codelineno-31-36"></a><span class="k">else</span>
<a id="__codelineno-31-37" name="__codelineno-31-37"></a><span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[BUILD+RUN] Running CMake...&quot;</span>
<a id="__codelineno-31-38" name="__codelineno-31-38"></a><span class="w">  </span>cmake<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">SRC_DIR</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-31-39" name="__codelineno-31-39"></a>
<a id="__codelineno-31-40" name="__codelineno-31-40"></a><span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[BUILD+RUN] Building...&quot;</span>
<a id="__codelineno-31-41" name="__codelineno-31-41"></a><span class="w">  </span>cmake<span class="w"> </span>--build<span class="w"> </span>.<span class="w"> </span>--<span class="w"> </span>-j<span class="s2">&quot;</span><span class="k">$(</span>nproc<span class="k">)</span><span class="s2">&quot;</span>
<a id="__codelineno-31-42" name="__codelineno-31-42"></a><span class="k">fi</span>
<a id="__codelineno-31-43" name="__codelineno-31-43"></a>
<a id="__codelineno-31-44" name="__codelineno-31-44"></a><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span>!<span class="w"> </span>-x<span class="w"> </span>exampleB5<span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<a id="__codelineno-31-45" name="__codelineno-31-45"></a><span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[BUILD+RUN] ERROR: build failed, exampleB5 not found.&quot;</span>
<a id="__codelineno-31-46" name="__codelineno-31-46"></a><span class="w">  </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<a id="__codelineno-31-47" name="__codelineno-31-47"></a><span class="k">fi</span>
<a id="__codelineno-31-48" name="__codelineno-31-48"></a>
<a id="__codelineno-31-49" name="__codelineno-31-49"></a><span class="nb">echo</span>
<a id="__codelineno-31-50" name="__codelineno-31-50"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[BUILD+RUN] Running exampleB5 with macro: </span><span class="si">${</span><span class="nv">MACRO</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-31-51" name="__codelineno-31-51"></a>./exampleB5<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">MACRO</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-31-52" name="__codelineno-31-52"></a>
<a id="__codelineno-31-53" name="__codelineno-31-53"></a><span class="nb">echo</span>
<a id="__codelineno-31-54" name="__codelineno-31-54"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[BUILD+RUN] ROOT files under </span><span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span><span class="s2">:&quot;</span>
<a id="__codelineno-31-55" name="__codelineno-31-55"></a>find<span class="w"> </span>.<span class="w"> </span>-maxdepth<span class="w"> </span><span class="m">3</span><span class="w"> </span>-type<span class="w"> </span>f<span class="w"> </span>-name<span class="w"> </span><span class="s1">&#39;*.root&#39;</span><span class="w"> </span>-print<span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-31-56" name="__codelineno-31-56"></a><span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[BUILD+RUN] Nessun .root trovato.&quot;</span>
<a id="__codelineno-31-57" name="__codelineno-31-57"></a>
<a id="__codelineno-31-58" name="__codelineno-31-58"></a><span class="nb">echo</span>
<a id="__codelineno-31-59" name="__codelineno-31-59"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[BUILD+RUN] Done: </span><span class="k">$(</span>date<span class="k">)</span><span class="s2">&quot;</span>
</code></pre></div></td></tr></table></div>
<p>Lo script viene reso eseguibile:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-32-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1"></a>chmod<span class="w"> </span>+x<span class="w"> </span>build_run_B5_exec.sh
</code></pre></div></td></tr></table></div>
<p>Il file di submit <code>build_run_B5_11.3.1.csi</code> è il seguente:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-33-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-33-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-33-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-33-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-33-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-33-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-33-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-33-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-33-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-33-10">10</a></span>
<span class="normal"><a href="#__codelineno-33-11">11</a></span>
<span class="normal"><a href="#__codelineno-33-12">12</a></span>
<span class="normal"><a href="#__codelineno-33-13">13</a></span>
<span class="normal"><a href="#__codelineno-33-14">14</a></span>
<span class="normal"><a href="#__codelineno-33-15">15</a></span>
<span class="normal"><a href="#__codelineno-33-16">16</a></span>
<span class="normal"><a href="#__codelineno-33-17">17</a></span>
<span class="normal"><a href="#__codelineno-33-18">18</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-33-1" name="__codelineno-33-1"></a><span class="nv">universe</span><span class="w">        </span><span class="o">=</span><span class="w"> </span>vanilla
<a id="__codelineno-33-2" name="__codelineno-33-2"></a>
<a id="__codelineno-33-3" name="__codelineno-33-3"></a><span class="nv">initialdir</span><span class="w">      </span><span class="o">=</span><span class="w"> </span>/lustrehome/bob/condor_tests/build_run_B5_11.3.1
<a id="__codelineno-33-4" name="__codelineno-33-4"></a>
<a id="__codelineno-33-5" name="__codelineno-33-5"></a><span class="nv">executable</span><span class="w">      </span><span class="o">=</span><span class="w"> </span>build_run_B5_exec.sh
<a id="__codelineno-33-6" name="__codelineno-33-6"></a><span class="nv">arguments</span><span class="w">       </span><span class="o">=</span>
<a id="__codelineno-33-7" name="__codelineno-33-7"></a>
<a id="__codelineno-33-8" name="__codelineno-33-8"></a><span class="nv">container_image</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>G4_v11.3.1.sif
<a id="__codelineno-33-9" name="__codelineno-33-9"></a>
<a id="__codelineno-33-10" name="__codelineno-33-10"></a><span class="nv">request_cpus</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="m">4</span>
<a id="__codelineno-33-11" name="__codelineno-33-11"></a><span class="nv">request_memory</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="m">4</span><span class="w"> </span>GB
<a id="__codelineno-33-12" name="__codelineno-33-12"></a><span class="nv">request_disk</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="m">8</span><span class="w"> </span>GB
<a id="__codelineno-33-13" name="__codelineno-33-13"></a>
<a id="__codelineno-33-14" name="__codelineno-33-14"></a><span class="nv">output</span><span class="w">          </span><span class="o">=</span><span class="w"> </span>logs/build_run_<span class="k">$(</span>ClusterId<span class="k">)</span>.<span class="k">$(</span>ProcId<span class="k">)</span>.out
<a id="__codelineno-33-15" name="__codelineno-33-15"></a><span class="nv">error</span><span class="w">           </span><span class="o">=</span><span class="w"> </span>logs/build_run_<span class="k">$(</span>ClusterId<span class="k">)</span>.<span class="k">$(</span>ProcId<span class="k">)</span>.err
<a id="__codelineno-33-16" name="__codelineno-33-16"></a><span class="nv">log</span><span class="w">             </span><span class="o">=</span><span class="w"> </span>logs/build_run_<span class="k">$(</span>ClusterId<span class="k">)</span>.<span class="k">$(</span>ProcId<span class="k">)</span>.log
<a id="__codelineno-33-17" name="__codelineno-33-17"></a>
<a id="__codelineno-33-18" name="__codelineno-33-18"></a>queue<span class="w"> </span><span class="m">1</span>
</code></pre></div></td></tr></table></div>
<p>La sottomissione avviene con:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-34-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-34-1" name="__codelineno-34-1"></a>condor_submit<span class="w"> </span>build_run_B5_11.3.1.csi
</code></pre></div></td></tr></table></div>
<p>Alla conclusione del job, la directory <code>B5_build_condor</code> contiene sia i file generati da CMake, sia l’eseguibile <code>exampleB5</code>, sia i file di output del run (ad esempio file ROOT). Tutti questi file risiedono in <code>/lustrehome/bob/condor_tests/build_run_B5_11.3.1/B5_build_condor</code> e sono quindi accessibili per analisi successive.</p>
<hr />
<h3 id="sec-esempio5">Esempio 5: progetto CsI-WLS con Python<a class="headerlink" href="#sec-esempio5" title="Permanent link">&para;</a></h3>
<p>L’ultimo esempio mostra una situazione più vicina a un caso reale, in cui un’applicazione Geant4 custom (CsI-WLS) viene compilata da sorgente con CMake e poi eseguita molte volte con parametri diversi, gestiti da uno script Python. Per questo caso si sfrutta l’immagine <code>G4_v10.6.3_NOMULTITHREAD.sif</code>, che contiene Geant4 10.6.3 senza multithreading, ROOT 6.36.4 e Python3 con le librerie principali.</p>
<p>Si assume che il progetto CsI-WLS esista già in una directory di sviluppo, ad esempio <code>/lustrehome/bob/ADAPT/simulation/CsI-WLS_v1.2.2</code>, che contiene una sottodirectory <code>src</code> con i file CMake e il codice. Per rendere il job auto-contenuto dentro <code>condor_tests</code> si copia solo la directory <code>src</code>:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-35-1">1</a></span>
<span class="normal"><a href="#__codelineno-35-2">2</a></span>
<span class="normal"><a href="#__codelineno-35-3">3</a></span>
<span class="normal"><a href="#__codelineno-35-4">4</a></span>
<span class="normal"><a href="#__codelineno-35-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-35-1" name="__codelineno-35-1"></a><span class="nb">cd</span><span class="w"> </span>/lustrehome/bob/condor_tests
<a id="__codelineno-35-2" name="__codelineno-35-2"></a>mkdir<span class="w"> </span>-p<span class="w"> </span>CsI-WLS_v1.2.2
<a id="__codelineno-35-3" name="__codelineno-35-3"></a>cp<span class="w"> </span>-r<span class="w"> </span>/lustrehome/bob/ADAPT/simulation/CsI-WLS_v1.2.2/src<span class="w"> </span>CsI-WLS_v1.2.2/
<a id="__codelineno-35-4" name="__codelineno-35-4"></a><span class="nb">cd</span><span class="w"> </span>CsI-WLS_v1.2.2
<a id="__codelineno-35-5" name="__codelineno-35-5"></a>mkdir<span class="w"> </span>-p<span class="w"> </span>logs
</code></pre></div></td></tr></table></div>
<p>Si crea il link all’immagine senza multithreading di <code>alice</code>:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-36-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-36-1" name="__codelineno-36-1"></a>ln<span class="w"> </span>-sf<span class="w"> </span>/lustrehome/alice/apptainer_images/G4_v10.6.3_NOMULTITHREAD.sif<span class="w"> </span>G4_v10.6.3_NOMULTITHREAD.sif
</code></pre></div></td></tr></table></div>
<p>Nella directory <code>src</code> si definisce lo script Python che si aspetta di essere eseguito da dentro <code>build</code> (dove esiste <code>./CsI-WLS</code>). Questo script genera un certo numero di macro, ognuna con un seed diverso, e per ciascuna macro lancia l’eseguibile:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-37-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-37-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-37-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-37-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-37-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-37-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-37-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-37-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-37-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-37-10">10</a></span>
<span class="normal"><a href="#__codelineno-37-11">11</a></span>
<span class="normal"><a href="#__codelineno-37-12">12</a></span>
<span class="normal"><a href="#__codelineno-37-13">13</a></span>
<span class="normal"><a href="#__codelineno-37-14">14</a></span>
<span class="normal"><a href="#__codelineno-37-15">15</a></span>
<span class="normal"><a href="#__codelineno-37-16">16</a></span>
<span class="normal"><a href="#__codelineno-37-17">17</a></span>
<span class="normal"><a href="#__codelineno-37-18">18</a></span>
<span class="normal"><a href="#__codelineno-37-19">19</a></span>
<span class="normal"><a href="#__codelineno-37-20">20</a></span>
<span class="normal"><a href="#__codelineno-37-21">21</a></span>
<span class="normal"><a href="#__codelineno-37-22">22</a></span>
<span class="normal"><a href="#__codelineno-37-23">23</a></span>
<span class="normal"><a href="#__codelineno-37-24">24</a></span>
<span class="normal"><a href="#__codelineno-37-25">25</a></span>
<span class="normal"><a href="#__codelineno-37-26">26</a></span>
<span class="normal"><a href="#__codelineno-37-27">27</a></span>
<span class="normal"><a href="#__codelineno-37-28">28</a></span>
<span class="normal"><a href="#__codelineno-37-29">29</a></span>
<span class="normal"><a href="#__codelineno-37-30">30</a></span>
<span class="normal"><a href="#__codelineno-37-31">31</a></span>
<span class="normal"><a href="#__codelineno-37-32">32</a></span>
<span class="normal"><a href="#__codelineno-37-33">33</a></span>
<span class="normal"><a href="#__codelineno-37-34">34</a></span>
<span class="normal"><a href="#__codelineno-37-35">35</a></span>
<span class="normal"><a href="#__codelineno-37-36">36</a></span>
<span class="normal"><a href="#__codelineno-37-37">37</a></span>
<span class="normal"><a href="#__codelineno-37-38">38</a></span>
<span class="normal"><a href="#__codelineno-37-39">39</a></span>
<span class="normal"><a href="#__codelineno-37-40">40</a></span>
<span class="normal"><a href="#__codelineno-37-41">41</a></span>
<span class="normal"><a href="#__codelineno-37-42">42</a></span>
<span class="normal"><a href="#__codelineno-37-43">43</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-37-1" name="__codelineno-37-1"></a><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<a id="__codelineno-37-2" name="__codelineno-37-2"></a><span class="kn">import</span> <span class="nn">os</span>
<a id="__codelineno-37-3" name="__codelineno-37-3"></a><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span> 
<a id="__codelineno-37-4" name="__codelineno-37-4"></a>
<a id="__codelineno-37-5" name="__codelineno-37-5"></a><span class="n">DIR_MAC</span> <span class="o">=</span> <span class="s2">&quot;./mac_electron&quot;</span>
<a id="__codelineno-37-6" name="__codelineno-37-6"></a><span class="n">DIR_ROOT</span> <span class="o">=</span> <span class="s2">&quot;rootOutput_electron&quot;</span>
<a id="__codelineno-37-7" name="__codelineno-37-7"></a>
<a id="__codelineno-37-8" name="__codelineno-37-8"></a><span class="n">N_EVENTS</span> <span class="o">=</span> <span class="mi">10</span>
<a id="__codelineno-37-9" name="__codelineno-37-9"></a><span class="n">subdir</span> <span class="o">=</span> <span class="s2">&quot;random_rectangular_source_200keV&quot;</span>
<a id="__codelineno-37-10" name="__codelineno-37-10"></a><span class="n">nfiles</span> <span class="o">=</span> <span class="mi">50</span>
<a id="__codelineno-37-11" name="__codelineno-37-11"></a>
<a id="__codelineno-37-12" name="__codelineno-37-12"></a><span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nfiles</span><span class="p">):</span>
<a id="__codelineno-37-13" name="__codelineno-37-13"></a>    <span class="n">seed1</span><span class="p">,</span> <span class="n">seed2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">**</span><span class="mi">32</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-37-14" name="__codelineno-37-14"></a>
<a id="__codelineno-37-15" name="__codelineno-37-15"></a>    <span class="n">mac</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">DIR_MAC</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">subdir</span><span class="si">}</span><span class="s2">/&quot;</span>
<a id="__codelineno-37-16" name="__codelineno-37-16"></a>           <span class="sa">f</span><span class="s2">&quot;random_rectangular_source_electron_ene_&quot;</span>
<a id="__codelineno-37-17" name="__codelineno-37-17"></a>           <span class="sa">f</span><span class="s2">&quot;200keV_ly1_n</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">.mac&quot;</span><span class="p">)</span>
<a id="__codelineno-37-18" name="__codelineno-37-18"></a>    <span class="n">root</span> <span class="o">=</span> <span class="n">mac</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">DIR_MAC</span><span class="p">,</span> <span class="n">DIR_ROOT</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.mac&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-37-19" name="__codelineno-37-19"></a>
<a id="__codelineno-37-20" name="__codelineno-37-20"></a>    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">mac</span><span class="p">),</span>  <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-37-21" name="__codelineno-37-21"></a>    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">root</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-37-22" name="__codelineno-37-22"></a>
<a id="__codelineno-37-23" name="__codelineno-37-23"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-37-24" name="__codelineno-37-24"></a>        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
<a id="__codelineno-37-25" name="__codelineno-37-25"></a>            <span class="s2">&quot;/run/initialize</span><span class="se">\n</span><span class="s2">&quot;</span>
<a id="__codelineno-37-26" name="__codelineno-37-26"></a>            <span class="s2">&quot;/tracking/verbose 0</span><span class="se">\n</span><span class="s2">&quot;</span>
<a id="__codelineno-37-27" name="__codelineno-37-27"></a>            <span class="s2">&quot;/gps/particle e-</span><span class="se">\n</span><span class="s2">&quot;</span>
<a id="__codelineno-37-28" name="__codelineno-37-28"></a>            <span class="s2">&quot;/gps/position 0 0 0 mm</span><span class="se">\n</span><span class="s2">&quot;</span>
<a id="__codelineno-37-29" name="__codelineno-37-29"></a>            <span class="s2">&quot;/gps/direction 0 0 -1</span><span class="se">\n</span><span class="s2">&quot;</span>
<a id="__codelineno-37-30" name="__codelineno-37-30"></a>            <span class="sa">f</span><span class="s2">&quot;/random/setSeeds [</span><span class="si">{</span><span class="n">seed1</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">seed2</span><span class="si">}</span><span class="s2">]</span><span class="se">\n</span><span class="s2">&quot;</span>
<a id="__codelineno-37-31" name="__codelineno-37-31"></a>            <span class="s2">&quot;/gps/pos/type Plane</span><span class="se">\n</span><span class="s2">&quot;</span>
<a id="__codelineno-37-32" name="__codelineno-37-32"></a>            <span class="s2">&quot;/gps/pos/shape Rectangle</span><span class="se">\n</span><span class="s2">&quot;</span>
<a id="__codelineno-37-33" name="__codelineno-37-33"></a>            <span class="s2">&quot;/gps/pos/halfx 220 mm</span><span class="se">\n</span><span class="s2">&quot;</span>
<a id="__codelineno-37-34" name="__codelineno-37-34"></a>            <span class="s2">&quot;/gps/pos/halfy 220 mm</span><span class="se">\n</span><span class="s2">&quot;</span>
<a id="__codelineno-37-35" name="__codelineno-37-35"></a>            <span class="s2">&quot;/gps/ene/mono 200 keV</span><span class="se">\n</span><span class="s2">&quot;</span>
<a id="__codelineno-37-36" name="__codelineno-37-36"></a>            <span class="sa">f</span><span class="s2">&quot;/RunManager/NameOfOutputFile </span><span class="si">{</span><span class="n">root</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
<a id="__codelineno-37-37" name="__codelineno-37-37"></a>            <span class="sa">f</span><span class="s2">&quot;/run/beamOn </span><span class="si">{</span><span class="n">N_EVENTS</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
<a id="__codelineno-37-38" name="__codelineno-37-38"></a>        <span class="p">)</span>
<a id="__codelineno-37-39" name="__codelineno-37-39"></a>
<a id="__codelineno-37-40" name="__codelineno-37-40"></a>    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;./CsI-WLS </span><span class="si">{</span><span class="n">mac</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-37-41" name="__codelineno-37-41"></a>
<a id="__codelineno-37-42" name="__codelineno-37-42"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> </span><span class="si">{</span><span class="n">N_EVENTS</span><span class="o">*</span><span class="n">nfiles</span><span class="si">}</span><span class="s2"> eventi salvati in &quot;</span>
<a id="__codelineno-37-43" name="__codelineno-37-43"></a>      <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">DIR_MAC</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">subdir</span><span class="si">}</span><span class="s2"> e simulati con ./CsI-WLS&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<p>Questo file può essere salvato come <code>src/run_electrons_batch.py</code> all’interno della copia di CsI-WLS sotto <code>condor_tests</code>.</p>
<p>Nella root della directory <code>CsI-WLS_v1.2.2</code> si definisce lo script <code>run_CsI_WLS_electron_batch.sh</code>, che compila il progetto nella directory <code>build</code> e poi lancia lo script Python:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-38-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-38-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-38-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-38-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-38-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-38-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-38-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-38-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-38-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-38-10">10</a></span>
<span class="normal"><a href="#__codelineno-38-11">11</a></span>
<span class="normal"><a href="#__codelineno-38-12">12</a></span>
<span class="normal"><a href="#__codelineno-38-13">13</a></span>
<span class="normal"><a href="#__codelineno-38-14">14</a></span>
<span class="normal"><a href="#__codelineno-38-15">15</a></span>
<span class="normal"><a href="#__codelineno-38-16">16</a></span>
<span class="normal"><a href="#__codelineno-38-17">17</a></span>
<span class="normal"><a href="#__codelineno-38-18">18</a></span>
<span class="normal"><a href="#__codelineno-38-19">19</a></span>
<span class="normal"><a href="#__codelineno-38-20">20</a></span>
<span class="normal"><a href="#__codelineno-38-21">21</a></span>
<span class="normal"><a href="#__codelineno-38-22">22</a></span>
<span class="normal"><a href="#__codelineno-38-23">23</a></span>
<span class="normal"><a href="#__codelineno-38-24">24</a></span>
<span class="normal"><a href="#__codelineno-38-25">25</a></span>
<span class="normal"><a href="#__codelineno-38-26">26</a></span>
<span class="normal"><a href="#__codelineno-38-27">27</a></span>
<span class="normal"><a href="#__codelineno-38-28">28</a></span>
<span class="normal"><a href="#__codelineno-38-29">29</a></span>
<span class="normal"><a href="#__codelineno-38-30">30</a></span>
<span class="normal"><a href="#__codelineno-38-31">31</a></span>
<span class="normal"><a href="#__codelineno-38-32">32</a></span>
<span class="normal"><a href="#__codelineno-38-33">33</a></span>
<span class="normal"><a href="#__codelineno-38-34">34</a></span>
<span class="normal"><a href="#__codelineno-38-35">35</a></span>
<span class="normal"><a href="#__codelineno-38-36">36</a></span>
<span class="normal"><a href="#__codelineno-38-37">37</a></span>
<span class="normal"><a href="#__codelineno-38-38">38</a></span>
<span class="normal"><a href="#__codelineno-38-39">39</a></span>
<span class="normal"><a href="#__codelineno-38-40">40</a></span>
<span class="normal"><a href="#__codelineno-38-41">41</a></span>
<span class="normal"><a href="#__codelineno-38-42">42</a></span>
<span class="normal"><a href="#__codelineno-38-43">43</a></span>
<span class="normal"><a href="#__codelineno-38-44">44</a></span>
<span class="normal"><a href="#__codelineno-38-45">45</a></span>
<span class="normal"><a href="#__codelineno-38-46">46</a></span>
<span class="normal"><a href="#__codelineno-38-47">47</a></span>
<span class="normal"><a href="#__codelineno-38-48">48</a></span>
<span class="normal"><a href="#__codelineno-38-49">49</a></span>
<span class="normal"><a href="#__codelineno-38-50">50</a></span>
<span class="normal"><a href="#__codelineno-38-51">51</a></span>
<span class="normal"><a href="#__codelineno-38-52">52</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-38-1" name="__codelineno-38-1"></a><span class="ch">#!/bin/bash</span>
<a id="__codelineno-38-2" name="__codelineno-38-2"></a><span class="nb">set</span><span class="w"> </span>-euo<span class="w"> </span>pipefail
<a id="__codelineno-38-3" name="__codelineno-38-3"></a>
<a id="__codelineno-38-4" name="__codelineno-38-4"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[PYRUN] Start: </span><span class="k">$(</span>date<span class="k">)</span><span class="s2">&quot;</span>
<a id="__codelineno-38-5" name="__codelineno-38-5"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[PYRUN] Host: </span><span class="k">$(</span>hostname<span class="k">)</span><span class="s2">&quot;</span>
<a id="__codelineno-38-6" name="__codelineno-38-6"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[PYRUN] User: </span><span class="k">$(</span>whoami<span class="k">)</span><span class="s2">&quot;</span>
<a id="__codelineno-38-7" name="__codelineno-38-7"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[PYRUN] Pwd:  </span><span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span><span class="s2">&quot;</span>
<a id="__codelineno-38-8" name="__codelineno-38-8"></a><span class="nb">echo</span>
<a id="__codelineno-38-9" name="__codelineno-38-9"></a>
<a id="__codelineno-38-10" name="__codelineno-38-10"></a><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span>-f<span class="w"> </span>/opt/geant4/bin/geant4.sh<span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<a id="__codelineno-38-11" name="__codelineno-38-11"></a><span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[PYRUN] Sourcing Geant4...&quot;</span>
<a id="__codelineno-38-12" name="__codelineno-38-12"></a><span class="w">  </span><span class="nb">source</span><span class="w"> </span>/opt/geant4/bin/geant4.sh
<a id="__codelineno-38-13" name="__codelineno-38-13"></a><span class="k">fi</span>
<a id="__codelineno-38-14" name="__codelineno-38-14"></a><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span>-f<span class="w"> </span>/opt/root/bin/thisroot.sh<span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<a id="__codelineno-38-15" name="__codelineno-38-15"></a><span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[PYRUN] Sourcing ROOT...&quot;</span>
<a id="__codelineno-38-16" name="__codelineno-38-16"></a><span class="w">  </span><span class="nb">source</span><span class="w"> </span>/opt/root/bin/thisroot.sh
<a id="__codelineno-38-17" name="__codelineno-38-17"></a><span class="k">fi</span>
<a id="__codelineno-38-18" name="__codelineno-38-18"></a>
<a id="__codelineno-38-19" name="__codelineno-38-19"></a><span class="nv">BUILD_DIR</span><span class="o">=</span><span class="s2">&quot;build&quot;</span>
<a id="__codelineno-38-20" name="__codelineno-38-20"></a><span class="nv">SRC_DIR</span><span class="o">=</span><span class="s2">&quot;src&quot;</span>
<a id="__codelineno-38-21" name="__codelineno-38-21"></a>
<a id="__codelineno-38-22" name="__codelineno-38-22"></a>mkdir<span class="w"> </span>-p<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">BUILD_DIR</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-38-23" name="__codelineno-38-23"></a><span class="nb">cd</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">BUILD_DIR</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-38-24" name="__codelineno-38-24"></a>
<a id="__codelineno-38-25" name="__codelineno-38-25"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[PYRUN] Now in build dir: </span><span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span><span class="s2">&quot;</span>
<a id="__codelineno-38-26" name="__codelineno-38-26"></a>
<a id="__codelineno-38-27" name="__codelineno-38-27"></a><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span>-x<span class="w"> </span>CsI-WLS<span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<a id="__codelineno-38-28" name="__codelineno-38-28"></a><span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[PYRUN] CsI-WLS already built, skipping cmake/cmake --build.&quot;</span>
<a id="__codelineno-38-29" name="__codelineno-38-29"></a><span class="k">else</span>
<a id="__codelineno-38-30" name="__codelineno-38-30"></a><span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[PYRUN] Configuring with CMake...&quot;</span>
<a id="__codelineno-38-31" name="__codelineno-38-31"></a><span class="w">  </span>cmake<span class="w"> </span><span class="s2">&quot;../</span><span class="si">${</span><span class="nv">SRC_DIR</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-38-32" name="__codelineno-38-32"></a>
<a id="__codelineno-38-33" name="__codelineno-38-33"></a><span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[PYRUN] Building CsI-WLS...&quot;</span>
<a id="__codelineno-38-34" name="__codelineno-38-34"></a><span class="w">  </span>cmake<span class="w"> </span>--build<span class="w"> </span>.<span class="w"> </span>--<span class="w"> </span>-j<span class="s2">&quot;</span><span class="k">$(</span>nproc<span class="k">)</span><span class="s2">&quot;</span>
<a id="__codelineno-38-35" name="__codelineno-38-35"></a><span class="k">fi</span>
<a id="__codelineno-38-36" name="__codelineno-38-36"></a>
<a id="__codelineno-38-37" name="__codelineno-38-37"></a><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span>!<span class="w"> </span>-x<span class="w"> </span>CsI-WLS<span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<a id="__codelineno-38-38" name="__codelineno-38-38"></a><span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[PYRUN] ERROR: CsI-WLS binary not found after build.&quot;</span>
<a id="__codelineno-38-39" name="__codelineno-38-39"></a><span class="w">  </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<a id="__codelineno-38-40" name="__codelineno-38-40"></a><span class="k">fi</span>
<a id="__codelineno-38-41" name="__codelineno-38-41"></a>
<a id="__codelineno-38-42" name="__codelineno-38-42"></a><span class="nb">echo</span>
<a id="__codelineno-38-43" name="__codelineno-38-43"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[PYRUN] Running Python batch script...&quot;</span>
<a id="__codelineno-38-44" name="__codelineno-38-44"></a>python3<span class="w"> </span>../source/run_electrons_batch.py
<a id="__codelineno-38-45" name="__codelineno-38-45"></a>
<a id="__codelineno-38-46" name="__codelineno-38-46"></a><span class="nb">echo</span>
<a id="__codelineno-38-47" name="__codelineno-38-47"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[PYRUN] ROOT files under rootOutput_electron/:&quot;</span>
<a id="__codelineno-38-48" name="__codelineno-38-48"></a>find<span class="w"> </span>rootOutput_electron<span class="w"> </span>-maxdepth<span class="w"> </span><span class="m">3</span><span class="w"> </span>-type<span class="w"> </span>f<span class="w"> </span>-name<span class="w"> </span><span class="s1">&#39;*.root&#39;</span><span class="w"> </span>-print<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-38-49" name="__codelineno-38-49"></a><span class="w">  </span><span class="o">||</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[PYRUN] Nessun .root trovato.&quot;</span>
<a id="__codelineno-38-50" name="__codelineno-38-50"></a>
<a id="__codelineno-38-51" name="__codelineno-38-51"></a><span class="nb">echo</span>
<a id="__codelineno-38-52" name="__codelineno-38-52"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[PYRUN] Done at </span><span class="k">$(</span>date<span class="k">)</span><span class="s2">&quot;</span>
</code></pre></div></td></tr></table></div>
<p>Lo script va reso eseguibile:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-39-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-39-1" name="__codelineno-39-1"></a>chmod<span class="w"> </span>+x<span class="w"> </span>run_CsI_WLS_electron_batch.sh
</code></pre></div></td></tr></table></div>
<p>Infine si definisce il file di submit <code>CsI_WLS_python_electrons.csi</code>:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-40-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-40-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-40-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-40-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-40-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-40-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-40-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-40-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-40-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-40-10">10</a></span>
<span class="normal"><a href="#__codelineno-40-11">11</a></span>
<span class="normal"><a href="#__codelineno-40-12">12</a></span>
<span class="normal"><a href="#__codelineno-40-13">13</a></span>
<span class="normal"><a href="#__codelineno-40-14">14</a></span>
<span class="normal"><a href="#__codelineno-40-15">15</a></span>
<span class="normal"><a href="#__codelineno-40-16">16</a></span>
<span class="normal"><a href="#__codelineno-40-17">17</a></span>
<span class="normal"><a href="#__codelineno-40-18">18</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-40-1" name="__codelineno-40-1"></a><span class="nv">universe</span><span class="w">        </span><span class="o">=</span><span class="w"> </span>vanilla
<a id="__codelineno-40-2" name="__codelineno-40-2"></a>
<a id="__codelineno-40-3" name="__codelineno-40-3"></a><span class="nv">initialdir</span><span class="w">      </span><span class="o">=</span><span class="w"> </span>/lustrehome/bob/condor_tests/CsI-WLS_v1.2.2
<a id="__codelineno-40-4" name="__codelineno-40-4"></a>
<a id="__codelineno-40-5" name="__codelineno-40-5"></a><span class="nv">executable</span><span class="w">      </span><span class="o">=</span><span class="w"> </span>run_CsI_WLS_electron_batch.sh
<a id="__codelineno-40-6" name="__codelineno-40-6"></a><span class="nv">arguments</span><span class="w">       </span><span class="o">=</span>
<a id="__codelineno-40-7" name="__codelineno-40-7"></a>
<a id="__codelineno-40-8" name="__codelineno-40-8"></a><span class="nv">container_image</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>G4_v10.6.3_NOMULTITHREAD.sif
<a id="__codelineno-40-9" name="__codelineno-40-9"></a>
<a id="__codelineno-40-10" name="__codelineno-40-10"></a><span class="nv">request_cpus</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="m">1</span>
<a id="__codelineno-40-11" name="__codelineno-40-11"></a><span class="nv">request_memory</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="w"> </span>GB
<a id="__codelineno-40-12" name="__codelineno-40-12"></a><span class="nv">request_disk</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="m">16</span><span class="w"> </span>GB
<a id="__codelineno-40-13" name="__codelineno-40-13"></a>
<a id="__codelineno-40-14" name="__codelineno-40-14"></a><span class="nv">output</span><span class="w">          </span><span class="o">=</span><span class="w"> </span>logs/pyCsI_<span class="k">$(</span>ClusterId<span class="k">)</span>.<span class="k">$(</span>ProcId<span class="k">)</span>.out
<a id="__codelineno-40-15" name="__codelineno-40-15"></a><span class="nv">error</span><span class="w">           </span><span class="o">=</span><span class="w"> </span>logs/pyCsI_<span class="k">$(</span>ClusterId<span class="k">)</span>.<span class="k">$(</span>ProcId<span class="k">)</span>.err
<a id="__codelineno-40-16" name="__codelineno-40-16"></a><span class="nv">log</span><span class="w">             </span><span class="o">=</span><span class="w"> </span>logs/pyCsI_<span class="k">$(</span>ClusterId<span class="k">)</span>.<span class="k">$(</span>ProcId<span class="k">)</span>.log
<a id="__codelineno-40-17" name="__codelineno-40-17"></a>
<a id="__codelineno-40-18" name="__codelineno-40-18"></a>queue<span class="w"> </span><span class="m">1</span>
</code></pre></div></td></tr></table></div>
<p>La sottomissione avviene con:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-41-1">1</a></span>
<span class="normal"><a href="#__codelineno-41-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-41-1" name="__codelineno-41-1"></a><span class="nb">cd</span><span class="w"> </span>/lustrehome/bob/condor_tests/CsI-WLS_v1.2.2
<a id="__codelineno-41-2" name="__codelineno-41-2"></a>condor_submit<span class="w"> </span>CsI_WLS_python_electrons.csi
</code></pre></div></td></tr></table></div>
<p>Quando il job è terminato, nella directory <code>build</code> compaiono l’eseguibile <code>CsI-WLS</code>, le macro generate dallo script Python e gli output ROOT. Tutti questi file sono salvati su lustre dentro <code>/lustrehome/bob/condor_tests/CsI-WLS_v1.2.2</code>.</p>
<hr />
<h2 id="sec-docker-sif"><strong>Costruzione di un’immagine Docker e conversione in SIF</strong><a class="headerlink" href="#sec-docker-sif" title="Permanent link">&para;</a></h2>
<p>Gli esempi della sezione <a href="#sec-esempi">Esempi</a> assumono che le immagini <code>.sif</code> siano già disponibili in una cartella condivisa, gestita dall’utente <code>alice</code>. Questa sezione descrive in modo sintetico come costruire un’immagine Docker con Geant4, ROOT e Python, come convertirla in un’immagine Apptainer/Singularity e come distribuirla agli altri utenti, senza entrare nei dettagli dei singoli comandi di installazione del software all’interno del container.</p>
<p>La costruzione di immagini Docker richiede una macchina con Docker installato e accessibile, ad esempio le macchine come <code>tesla02.recas.infn.ba.it</code>. Un utente può connettersi a quella macchina con le stesse credenziali delle macchine di frontend <code>ui-al9.recas.infn.ba.it</code>, preparare un <code>Dockerfile</code> e costruire l’immagine. Un esempio completo di <code>Dockerfile</code> per un ambiente Ubuntu 24.04 con Geant4, ROOT e Python3 è riportato in appendice, nella sezione <a href="#sec-dockerfile-esempio">Dockerfile di esempio per ambiente Geant4/ROOT</a>.</p>
<div class="admonition info">
<p class="admonition-title"> Dove gira Docker su ReCaS</p>
<p>Attualmente Docker è installato solo sulla macchina
<code>tesla02.recas.ba.infn.it</code>. Per usarlo occorre prima collegarsi da una
delle macchine di frontend:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-42-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-42-1" name="__codelineno-42-1"></a>ssh<span class="w"> </span>username@tesla02.recas.ba.infn.it
</code></pre></div></td></tr></table></div>
<p>Al primo accesso viene creata automaticamente la home locale su <code>tesla02</code>.
Tutta la fase di build e test interattivo delle immagini Docker va fatta su
<code>tesla02</code>; le immagini poi vengono caricate sul registry
<code>registry-clustergpu.recas.ba.infn.it</code> e da lì convertite in immagini
Apptainer/Singularity utilizzabili con HTCondor sui worker node.</p>
</div>
<p>Una volta scritto il <code>Dockerfile</code>, l’utente manutentore può costruire l’immagine con un comando del tipo:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-43-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-43-1" name="__codelineno-43-1"></a>docker<span class="w"> </span>build<span class="w"> </span>-t<span class="w"> </span>registry-clustergpu.recas.ba.infn.it/alice/geant4:10.6.3<span class="w"> </span>.
</code></pre></div></td></tr></table></div>
<p>In seguito, l’immagine può essere inviata al registry interno, dove le credenziali sono le stesse del frontend:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-44-1">1</a></span>
<span class="normal"><a href="#__codelineno-44-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-44-1" name="__codelineno-44-1"></a>docker<span class="w"> </span>login<span class="w"> </span>registry-clustergpu.recas.ba.infn.it
<a id="__codelineno-44-2" name="__codelineno-44-2"></a>docker<span class="w"> </span>push<span class="w"> </span>registry-clustergpu.recas.ba.infn.it/alice/geant4:10.6.3
</code></pre></div></td></tr></table></div>
<p>La conversione da immagine Docker a immagine Apptainer/Singularity deve avvenire un worker node dove Apptainer è installato e eseguire il comando <code>build</code>. Un esempio di comando è:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-45-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-45-1" name="__codelineno-45-1"></a>apptainer<span class="w"> </span>build<span class="w"> </span>G4_v10.6.3.sif<span class="w"> </span>docker://registry-clustergpu.recas.ba.infn.it/alice/geant4:10.6.3
</code></pre></div></td></tr></table></div>
<p>Il file <code>G4_v10.6.3.sif</code> così generato può essere copiato o spostato nella directory condivisa delle immagini:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-46-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-46-1" name="__codelineno-46-1"></a>mv<span class="w"> </span>G4_v10.6.3.sif<span class="w"> </span>/lustrehome/alice/apptainer_images/
</code></pre></div></td></tr></table></div>
<p>Dopo questo passaggio, tutti gli utenti (come <code>bob</code>) possono usare l’immagine nei propri job Condor creando un symlink nella <code>initialdir</code> e impostando <code>container_image</code> al nome del symlink, come mostrato nella sezione <a href="#sec-concetti-base">Concetti di base: container, Apptainer e HTCondor</a> e negli esempi.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Sia la build della immagine Docker che la conversione in <code>.sif</code> può anche essere fatta in locale sul proprio pc e poi copiata su una directory accessibile su lustrehome. </p>
</div>
<h3 id="comandi-essenziali-docker">Comandi essenziali Docker<a class="headerlink" href="#comandi-essenziali-docker" title="Permanent link">&para;</a></h3>
<p>Non è necessario che ogni utente conosca Docker in dettaglio, ma è utile riassumere i comandi più usati nel ciclo di vita di un’immagine. La costruzione da <code>Dockerfile</code> nella directory corrente avviene di solito con:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-47-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-47-1" name="__codelineno-47-1"></a>docker<span class="w"> </span>build<span class="w"> </span>-t<span class="w"> </span>nome_immagine:tag<span class="w"> </span>.
</code></pre></div></td></tr></table></div>
<p>Per visualizzare le immagini locali si può usare:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-48-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-48-1" name="__codelineno-48-1"></a>docker<span class="w"> </span>images
</code></pre></div></td></tr></table></div>
<p>Per testare interattivamente un’immagine, ad esempio verificando che gli script di ambiente siano corretti, si può avviare un container con:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-49-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-49-1" name="__codelineno-49-1"></a>docker<span class="w"> </span>run<span class="w"> </span>-it<span class="w"> </span>nome_immagine:tag
</code></pre></div></td></tr></table></div>
<p>Infine, per taggare e inviare un’immagine verso il registry remoto, si possono usare comandi del tipo:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-50-1">1</a></span>
<span class="normal"><a href="#__codelineno-50-2">2</a></span>
<span class="normal"><a href="#__codelineno-50-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-50-1" name="__codelineno-50-1"></a>docker<span class="w"> </span>tag<span class="w"> </span>nome_immagine:tag<span class="w"> </span>registry-clustergpu.recas.ba.infn.it/alice/nome_immagine:tag
<a id="__codelineno-50-2" name="__codelineno-50-2"></a>
<a id="__codelineno-50-3" name="__codelineno-50-3"></a>docker<span class="w"> </span>push<span class="w"> </span>registry-clustergpu.recas.ba.infn.it/alice/nome_immagine:tag
</code></pre></div></td></tr></table></div>
<p>Questi comandi vengono eseguiti sulla macchina che ha Docker installato, come <code>tesla02.recas.infn.ba.it</code>.</p>
<h3 id="comandi-essenziali-apptainersingularity">Comandi essenziali Apptainer/Singularity<a class="headerlink" href="#comandi-essenziali-apptainersingularity" title="Permanent link">&para;</a></h3>
<p>Apptainer viene utilizzato sia per testare manualmente le immagini sia in maniera indiretta tramite HTCondor. Per un test rapido si può eseguire un comando dentro un’immagine <code>.sif</code> con:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-51-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-51-1" name="__codelineno-51-1"></a>apptainer<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>G4_v11.3.1.sif<span class="w"> </span>geant4-config<span class="w"> </span>--version
</code></pre></div></td></tr></table></div>
<p>Per aprire una shell interattiva nel container si può usare:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-52-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-52-1" name="__codelineno-52-1"></a>apptainer<span class="w"> </span>shell<span class="w"> </span>G4_v11.3.1.sif
</code></pre></div></td></tr></table></div>
<p>La conversione da immagine Docker a <code>.sif</code> avviene, come già mostrato, con:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-53-1">1</a></span>
<span class="normal"><a href="#__codelineno-53-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-53-1" name="__codelineno-53-1"></a>apptainer<span class="w"> </span>build<span class="w"> </span>G4_v11.3.1.sif<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-53-2" name="__codelineno-53-2"></a><span class="w">  </span>docker://registry-clustergpu.recas.ba.infn.it/alice/geant4:11.3.1
</code></pre></div></td></tr></table></div>
<p>I job Condor che usano <code>container_image</code> nascondono questi dettagli, perché è il sistema a chiamare internamente Apptainer. Tuttavia, conoscere questi comandi aiuta a testare rapidamente un’immagine su una macchina di frontend prima di costruire i file <code>.csi</code>, come quelli della sezione <a href="#sec-esempi">Esempi</a>.</p>
<hr />
<h2 id="sec-kubernetes"><strong>Prospettive: uso di Kubernetes con container</strong><a class="headerlink" href="#sec-kubernetes" title="Permanent link">&para;</a></h2>
<p><em>(TODO)</em></p>
<hr />
<h2 id="sec-images"><strong>Immagini Docker / Apptainer disponibili su ReCaS</strong><a class="headerlink" href="#sec-images" title="Permanent link">&para;</a></h2>
<p>Questa sezione elenca alcune immagini già presenti sul registry di ReCaS o su
lustre che possono essere riutilizzate come base per nuovi progetti.<br />
L’elenco non è esaustivo e va considerato come “fotografia” dello stato attuale:
nel tempo possono essere aggiunte nuove immagini o aggiornate le versioni.</p>
<table>
<thead>
<tr>
<th>#</th>
<th>Docker image</th>
<th>Singularity/Apptainer path</th>
<th>Contenuto principale</th>
<th>Note</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td><code>federicacuna/herd_centos07_devtoolset11_root:v2</code></td>
<td>–</td>
<td>CentOS 7 + devtoolset-11 + ROOT, ambiente per HerdSoftware</td>
<td>Immagine su Docker Hub/registry esterno.</td>
</tr>
<tr>
<td>2</td>
<td><code>megalib-3.06</code></td>
<td>–</td>
<td>MEGAlib 3.06 con tutte le dipendenze necessarie</td>
<td>Usata per simulazioni MEGAlib.</td>
</tr>
<tr>
<td>3</td>
<td><code>registry-clustergpu.recas.ba.infn.it/marcocecca/geant4:10.6.3</code></td>
<td><code>/lustrehome/marcocecca/apptainer_images/G4_v10.6.3.sif</code></td>
<td>Ubuntu 24.04 + Geant4 10.6.3 + ROOT 6.36.4 + Python3/numpy/matplotlib</td>
<td>Dati Geant4 inclusi; env Geant4/ROOT inizializzato all’apertura del container.</td>
</tr>
<tr>
<td>4</td>
<td><code>registry-clustergpu.recas.ba.infn.it/marcocecca/geant4:10.6.3_NOMULTITHREAD</code></td>
<td><code>/lustrehome/marcocecca/apptainer_images/G4_v10.6.3_NOMULTITHREAD.sif</code></td>
<td>Come (3), ma con Geant4 10.6.3 compilato senza multithreading</td>
<td>Adatta a job single-thread (uno per core) con HTCondor.</td>
</tr>
<tr>
<td>5</td>
<td><code>registry-clustergpu.recas.ba.infn.it/marcocecca/geant4:11.3.1</code></td>
<td><code>/lustrehome/marcocecca/apptainer_images/G4_v11.3.1.sif</code></td>
<td>Ubuntu 24.04 + Geant4 11.3.1 + ROOT 6.36.4 + Python3/numpy/matplotlib</td>
<td>Dati Geant4 inclusi; env Geant4/ROOT inizializzato all’apertura del container.</td>
</tr>
</tbody>
</table>
<p>Se si utilizza una di queste immagini come base per nuovi workflow, è buona pratica:</p>
<ul>
<li>documentare nel proprio progetto quale <strong>tag</strong> specifico si sta usando;</li>
<li>generare nuove immagini con tag/versioni diverse quando servono modifiche significative;</li>
<li>mantenere questa sezione aggiornata nel tempo, aggiungendo righe per nuove immagini “ufficiali”.</li>
</ul>
<h2 id="appendice"><strong>Appendice</strong><a class="headerlink" href="#appendice" title="Permanent link">&para;</a></h2>
<h3 id="sec-dockerfile-esempio">Dockerfile di esempio per ambiente Geant4/ROOT<a class="headerlink" href="#sec-dockerfile-esempio" title="Permanent link">&para;</a></h3>
<p>In questa sezione è riportato un esempio completo di <code>Dockerfile</code> per costruire un’immagine Docker basata su Ubuntu 24.04, con Geant4, ROOT e Python3. Il risultato atteso è un’immagine che espone gli script di environment <code>/opt/geant4/bin/geant4.sh</code> e <code>/opt/root/bin/thisroot.sh</code> e che può essere convertita in un file <code>.sif</code> come descritto nella sezione <a href="#sec-docker-sif">Costruzione di un’immagine Docker e conversione in SIF</a>.</p>
<div class="admonition warning">
<p class="admonition-title"> USERNAME, USERID e GROUPID vanno modificati</p>
<p>Nel Dockerfile di esempio, i campi:
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Docker</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-54-1">1</a></span>
<span class="normal"><a href="#__codelineno-54-2">2</a></span>
<span class="normal"><a href="#__codelineno-54-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-54-1" name="__codelineno-54-1"></a><span class="k">ENV</span><span class="w"> </span><span class="nv">USERNAME</span><span class="o">=</span>alice
<a id="__codelineno-54-2" name="__codelineno-54-2"></a><span class="k">ENV</span><span class="w"> </span><span class="nv">USERID</span><span class="o">=</span><span class="m">000001</span>
<a id="__codelineno-54-3" name="__codelineno-54-3"></a><span class="k">ENV</span><span class="w"> </span><span class="nv">GROUPID</span><span class="o">=</span><span class="m">1234</span>
</code></pre></div></td></tr></table></div>
sono solo <strong>segnaposto</strong>. Prima di eseguire <code>docker build</code> vanno sostituiti con:</p>
<ul>
<li>il proprio nome utente su ReCaS (<code>USERNAME</code>),</li>
<li>il proprio UID numerico (<code>USERID</code>),</li>
<li>il proprio GID numerico (<code>GROUPID</code>).</li>
</ul>
<p>I valori corretti si ottengono, dalle macchine di frontend con:
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-55-1">1</a></span>
<span class="normal"><a href="#__codelineno-55-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-55-1" name="__codelineno-55-1"></a>id
<a id="__codelineno-55-2" name="__codelineno-55-2"></a><span class="c1"># uid=881525(alice) gid=2435(alice) groups=...</span>
</code></pre></div></td></tr></table></div></p>
<p>L’uso di un utente reale all’interno del container (con UID/GID coerenti a quelli
del cluster) è <strong>richiesto dai manuali ufficiali di ReCaS</strong> per garantire
che i file scritti dal container abbiano permessi corretti su lustre.</p>
</div>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Docker</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-56-1">  1</a></span>
<span class="normal"><a href="#__codelineno-56-2">  2</a></span>
<span class="normal"><a href="#__codelineno-56-3">  3</a></span>
<span class="normal"><a href="#__codelineno-56-4">  4</a></span>
<span class="normal"><a href="#__codelineno-56-5">  5</a></span>
<span class="normal"><a href="#__codelineno-56-6">  6</a></span>
<span class="normal"><a href="#__codelineno-56-7">  7</a></span>
<span class="normal"><a href="#__codelineno-56-8">  8</a></span>
<span class="normal"><a href="#__codelineno-56-9">  9</a></span>
<span class="normal"><a href="#__codelineno-56-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-56-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-56-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-56-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-56-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-56-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-56-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-56-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-56-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-56-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-56-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-56-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-56-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-56-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-56-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-56-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-56-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-56-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-56-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-56-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-56-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-56-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-56-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-56-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-56-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-56-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-56-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-56-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-56-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-56-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-56-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-56-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-56-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-56-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-56-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-56-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-56-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-56-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-56-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-56-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-56-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-56-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-56-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-56-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-56-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-56-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-56-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-56-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-56-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-56-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-56-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-56-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-56-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-56-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-56-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-56-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-56-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-56-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-56-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-56-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-56-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-56-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-56-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-56-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-56-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-56-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-56-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-56-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-56-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-56-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-56-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-56-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-56-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-56-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-56-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-56-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-56-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-56-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-56-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-56-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-56-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-56-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-56-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-56-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-56-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-56-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-56-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-56-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-56-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-56-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-56-100">100</a></span>
<span class="normal"><a href="#__codelineno-56-101">101</a></span>
<span class="normal"><a href="#__codelineno-56-102">102</a></span>
<span class="normal"><a href="#__codelineno-56-103">103</a></span>
<span class="normal"><a href="#__codelineno-56-104">104</a></span>
<span class="normal"><a href="#__codelineno-56-105">105</a></span>
<span class="normal"><a href="#__codelineno-56-106">106</a></span>
<span class="normal"><a href="#__codelineno-56-107">107</a></span>
<span class="normal"><a href="#__codelineno-56-108">108</a></span>
<span class="normal"><a href="#__codelineno-56-109">109</a></span>
<span class="normal"><a href="#__codelineno-56-110">110</a></span>
<span class="normal"><a href="#__codelineno-56-111">111</a></span>
<span class="normal"><a href="#__codelineno-56-112">112</a></span>
<span class="normal"><a href="#__codelineno-56-113">113</a></span>
<span class="normal"><a href="#__codelineno-56-114">114</a></span>
<span class="normal"><a href="#__codelineno-56-115">115</a></span>
<span class="normal"><a href="#__codelineno-56-116">116</a></span>
<span class="normal"><a href="#__codelineno-56-117">117</a></span>
<span class="normal"><a href="#__codelineno-56-118">118</a></span>
<span class="normal"><a href="#__codelineno-56-119">119</a></span>
<span class="normal"><a href="#__codelineno-56-120">120</a></span>
<span class="normal"><a href="#__codelineno-56-121">121</a></span>
<span class="normal"><a href="#__codelineno-56-122">122</a></span>
<span class="normal"><a href="#__codelineno-56-123">123</a></span>
<span class="normal"><a href="#__codelineno-56-124">124</a></span>
<span class="normal"><a href="#__codelineno-56-125">125</a></span>
<span class="normal"><a href="#__codelineno-56-126">126</a></span>
<span class="normal"><a href="#__codelineno-56-127">127</a></span>
<span class="normal"><a href="#__codelineno-56-128">128</a></span>
<span class="normal"><a href="#__codelineno-56-129">129</a></span>
<span class="normal"><a href="#__codelineno-56-130">130</a></span>
<span class="normal"><a href="#__codelineno-56-131">131</a></span>
<span class="normal"><a href="#__codelineno-56-132">132</a></span>
<span class="normal"><a href="#__codelineno-56-133">133</a></span>
<span class="normal"><a href="#__codelineno-56-134">134</a></span>
<span class="normal"><a href="#__codelineno-56-135">135</a></span>
<span class="normal"><a href="#__codelineno-56-136">136</a></span>
<span class="normal"><a href="#__codelineno-56-137">137</a></span>
<span class="normal"><a href="#__codelineno-56-138">138</a></span>
<span class="normal"><a href="#__codelineno-56-139">139</a></span>
<span class="normal"><a href="#__codelineno-56-140">140</a></span>
<span class="normal"><a href="#__codelineno-56-141">141</a></span>
<span class="normal"><a href="#__codelineno-56-142">142</a></span>
<span class="normal"><a href="#__codelineno-56-143">143</a></span>
<span class="normal"><a href="#__codelineno-56-144">144</a></span>
<span class="normal"><a href="#__codelineno-56-145">145</a></span>
<span class="normal"><a href="#__codelineno-56-146">146</a></span>
<span class="normal"><a href="#__codelineno-56-147">147</a></span>
<span class="normal"><a href="#__codelineno-56-148">148</a></span>
<span class="normal"><a href="#__codelineno-56-149">149</a></span>
<span class="normal"><a href="#__codelineno-56-150">150</a></span>
<span class="normal"><a href="#__codelineno-56-151">151</a></span>
<span class="normal"><a href="#__codelineno-56-152">152</a></span>
<span class="normal"><a href="#__codelineno-56-153">153</a></span>
<span class="normal"><a href="#__codelineno-56-154">154</a></span>
<span class="normal"><a href="#__codelineno-56-155">155</a></span>
<span class="normal"><a href="#__codelineno-56-156">156</a></span>
<span class="normal"><a href="#__codelineno-56-157">157</a></span>
<span class="normal"><a href="#__codelineno-56-158">158</a></span>
<span class="normal"><a href="#__codelineno-56-159">159</a></span>
<span class="normal"><a href="#__codelineno-56-160">160</a></span>
<span class="normal"><a href="#__codelineno-56-161">161</a></span>
<span class="normal"><a href="#__codelineno-56-162">162</a></span>
<span class="normal"><a href="#__codelineno-56-163">163</a></span>
<span class="normal"><a href="#__codelineno-56-164">164</a></span>
<span class="normal"><a href="#__codelineno-56-165">165</a></span>
<span class="normal"><a href="#__codelineno-56-166">166</a></span>
<span class="normal"><a href="#__codelineno-56-167">167</a></span>
<span class="normal"><a href="#__codelineno-56-168">168</a></span>
<span class="normal"><a href="#__codelineno-56-169">169</a></span>
<span class="normal"><a href="#__codelineno-56-170">170</a></span>
<span class="normal"><a href="#__codelineno-56-171">171</a></span>
<span class="normal"><a href="#__codelineno-56-172">172</a></span>
<span class="normal"><a href="#__codelineno-56-173">173</a></span>
<span class="normal"><a href="#__codelineno-56-174">174</a></span>
<span class="normal"><a href="#__codelineno-56-175">175</a></span>
<span class="normal"><a href="#__codelineno-56-176">176</a></span>
<span class="normal"><a href="#__codelineno-56-177">177</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-56-1" name="__codelineno-56-1"></a><span class="k">FROM</span><span class="w"> </span><span class="s">ubuntu:24.04</span>
<a id="__codelineno-56-2" name="__codelineno-56-2"></a>
<a id="__codelineno-56-3" name="__codelineno-56-3"></a><span class="k">LABEL</span><span class="w"> </span><span class="nv">author</span><span class="o">=</span><span class="s2">&quot;marcocecca&quot;</span>
<a id="__codelineno-56-4" name="__codelineno-56-4"></a><span class="k">LABEL</span><span class="w"> </span><span class="nv">version</span><span class="o">=</span><span class="s2">&quot;G4v11.3.1_Rootv6.36.4_Ubuntu24&quot;</span>
<a id="__codelineno-56-5" name="__codelineno-56-5"></a>
<a id="__codelineno-56-6" name="__codelineno-56-6"></a><span class="c"># ===========================</span>
<a id="__codelineno-56-7" name="__codelineno-56-7"></a><span class="c"># Env Geant4 + ROOT (base)</span>
<a id="__codelineno-56-8" name="__codelineno-56-8"></a><span class="c"># ===========================</span>
<a id="__codelineno-56-9" name="__codelineno-56-9"></a><span class="k">ENV</span><span class="w"> </span><span class="nv">DEBIAN_FRONTEND</span><span class="o">=</span>noninteractive<span class="w"> </span><span class="nv">TZ</span><span class="o">=</span>Etc/UTC
<a id="__codelineno-56-10" name="__codelineno-56-10"></a>
<a id="__codelineno-56-11" name="__codelineno-56-11"></a><span class="k">ENV</span><span class="w"> </span><span class="nv">G4VERSION</span><span class="o">=</span><span class="m">11</span>.3.1
<a id="__codelineno-56-12" name="__codelineno-56-12"></a><span class="k">ENV</span><span class="w"> </span><span class="nv">G4INSTALL</span><span class="o">=</span>/opt/geant4
<a id="__codelineno-56-13" name="__codelineno-56-13"></a><span class="k">ENV</span><span class="w"> </span><span class="nv">G4DATA_DIR</span><span class="o">=</span><span class="nv">$G4INSTALL</span>/share/Geant4/data
<a id="__codelineno-56-14" name="__codelineno-56-14"></a><span class="k">ENV</span><span class="w"> </span><span class="nv">G4LIB_DIR</span><span class="o">=</span><span class="nv">$G4INSTALL</span>/lib
<a id="__codelineno-56-15" name="__codelineno-56-15"></a><span class="k">ENV</span><span class="w"> </span><span class="nv">G4GDMLROOT</span><span class="o">=</span><span class="nv">$G4INSTALL</span>
<a id="__codelineno-56-16" name="__codelineno-56-16"></a>
<a id="__codelineno-56-17" name="__codelineno-56-17"></a><span class="c"># ROOT</span>
<a id="__codelineno-56-18" name="__codelineno-56-18"></a><span class="k">ENV</span><span class="w"> </span><span class="nv">ROOT_VERSION</span><span class="o">=</span><span class="m">6</span>.36.04
<a id="__codelineno-56-19" name="__codelineno-56-19"></a><span class="k">ENV</span><span class="w"> </span><span class="nv">ROOTSYS</span><span class="o">=</span>/opt/root
<a id="__codelineno-56-20" name="__codelineno-56-20"></a>
<a id="__codelineno-56-21" name="__codelineno-56-21"></a><span class="c"># ==========================================</span>
<a id="__codelineno-56-22" name="__codelineno-56-22"></a><span class="c"># Dipendenze base (Qt5 + OpenGL/X11 + ROOT + Python + Vdt)</span>
<a id="__codelineno-56-23" name="__codelineno-56-23"></a><span class="c"># ==========================================</span>
<a id="__codelineno-56-24" name="__codelineno-56-24"></a><span class="k">RUN</span><span class="w"> </span>apt-get<span class="w"> </span>update<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>--no-install-recommends<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-25" name="__codelineno-56-25"></a><span class="w">    </span>build-essential<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-26" name="__codelineno-56-26"></a><span class="w">    </span>cmake<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-27" name="__codelineno-56-27"></a><span class="w">    </span>git<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-28" name="__codelineno-56-28"></a><span class="w">    </span>pkg-config<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-29" name="__codelineno-56-29"></a><span class="w">    </span>ca-certificates<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-30" name="__codelineno-56-30"></a><span class="w">    </span>wget<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-31" name="__codelineno-56-31"></a><span class="w">    </span>curl<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-32" name="__codelineno-56-32"></a><span class="w">    </span>#<span class="w"> </span>Geant4<span class="w"> </span>+<span class="w"> </span>GDML
<a id="__codelineno-56-33" name="__codelineno-56-33"></a><span class="w">    </span>libxerces-c-dev<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-34" name="__codelineno-56-34"></a><span class="w">    </span>libexpat1-dev<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-35" name="__codelineno-56-35"></a><span class="w">    </span>#<span class="w"> </span>Qt5<span class="w"> </span>+<span class="w"> </span>OpenGL<span class="w"> </span>+<span class="w"> </span>X11
<a id="__codelineno-56-36" name="__codelineno-56-36"></a><span class="w">    </span>qtbase5-dev<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-37" name="__codelineno-56-37"></a><span class="w">    </span>qtbase5-dev-tools<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-38" name="__codelineno-56-38"></a><span class="w">    </span>qt5-qmake<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-39" name="__codelineno-56-39"></a><span class="w">    </span>libqt5opengl5-dev<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-40" name="__codelineno-56-40"></a><span class="w">    </span>libx11-dev<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-41" name="__codelineno-56-41"></a><span class="w">    </span>libxmu-dev<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-42" name="__codelineno-56-42"></a><span class="w">    </span>libxi-dev<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-43" name="__codelineno-56-43"></a><span class="w">    </span>libxrandr-dev<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-44" name="__codelineno-56-44"></a><span class="w">    </span>libxinerama-dev<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-45" name="__codelineno-56-45"></a><span class="w">    </span>libxcursor-dev<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-46" name="__codelineno-56-46"></a><span class="w">    </span>libgl1-mesa-dev<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-47" name="__codelineno-56-47"></a><span class="w">    </span>libglu1-mesa-dev<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-48" name="__codelineno-56-48"></a><span class="w">    </span>#<span class="w"> </span>runtime<span class="w"> </span>Qt/X11
<a id="__codelineno-56-49" name="__codelineno-56-49"></a><span class="w">    </span>libxkbcommon-x11-0<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-50" name="__codelineno-56-50"></a><span class="w">    </span>libfontconfig1<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-51" name="__codelineno-56-51"></a><span class="w">    </span>libxrender1<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-52" name="__codelineno-56-52"></a><span class="w">    </span>libxcb-icccm4<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-53" name="__codelineno-56-53"></a><span class="w">    </span>libxcb-image0<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-54" name="__codelineno-56-54"></a><span class="w">    </span>libxcb-keysyms1<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-55" name="__codelineno-56-55"></a><span class="w">    </span>libxcb-render-util0<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-56" name="__codelineno-56-56"></a><span class="w">    </span>libxcb-xfixes0<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-57" name="__codelineno-56-57"></a><span class="w">    </span>libxcb-xinerama0<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-58" name="__codelineno-56-58"></a><span class="w">    </span>#<span class="w"> </span>dipendenze<span class="w"> </span>ROOT
<a id="__codelineno-56-59" name="__codelineno-56-59"></a><span class="w">    </span>libxpm-dev<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-60" name="__codelineno-56-60"></a><span class="w">    </span>libxft-dev<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-61" name="__codelineno-56-61"></a><span class="w">    </span>libssl-dev<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-62" name="__codelineno-56-62"></a><span class="w">    </span>libpcre3-dev<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-63" name="__codelineno-56-63"></a><span class="w">    </span>libgsl-dev<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-64" name="__codelineno-56-64"></a><span class="w">    </span>libgraphviz-dev<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-65" name="__codelineno-56-65"></a><span class="w">    </span>libtbb12<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-66" name="__codelineno-56-66"></a><span class="w">    </span>libtbb-dev<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-67" name="__codelineno-56-67"></a><span class="w">    </span>libvdt-dev<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-68" name="__codelineno-56-68"></a><span class="w">    </span>#<span class="w"> </span>Python<span class="w"> </span>per<span class="w"> </span>gli<span class="w"> </span>script<span class="w"> </span>di<span class="w"> </span>simulazione
<a id="__codelineno-56-69" name="__codelineno-56-69"></a><span class="w">    </span>python3<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-70" name="__codelineno-56-70"></a><span class="w">    </span>python3-numpy<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-71" name="__codelineno-56-71"></a><span class="w">    </span>python3-matplotlib<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-72" name="__codelineno-56-72"></a><span class="w">    </span>python3-pip<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-73" name="__codelineno-56-73"></a><span class="w">    </span>#<span class="w"> </span>utility
<a id="__codelineno-56-74" name="__codelineno-56-74"></a><span class="w">    </span>adduser<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-75" name="__codelineno-56-75"></a><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>rm<span class="w"> </span>-rf<span class="w"> </span>/var/lib/apt/lists/*
<a id="__codelineno-56-76" name="__codelineno-56-76"></a>
<a id="__codelineno-56-77" name="__codelineno-56-77"></a><span class="c"># ================================</span>
<a id="__codelineno-56-78" name="__codelineno-56-78"></a><span class="c"># Mandatory ReCaS: utente reale</span>
<a id="__codelineno-56-79" name="__codelineno-56-79"></a><span class="c"># ================================</span>
<a id="__codelineno-56-80" name="__codelineno-56-80"></a><span class="k">ENV</span><span class="w"> </span><span class="nv">USERNAME</span><span class="o">=</span>alice
<a id="__codelineno-56-81" name="__codelineno-56-81"></a><span class="k">ENV</span><span class="w"> </span><span class="nv">USERID</span><span class="o">=</span><span class="m">000001</span>
<a id="__codelineno-56-82" name="__codelineno-56-82"></a><span class="k">ENV</span><span class="w"> </span><span class="nv">GROUPID</span><span class="o">=</span><span class="m">1234</span>
<a id="__codelineno-56-83" name="__codelineno-56-83"></a>
<a id="__codelineno-56-84" name="__codelineno-56-84"></a><span class="k">RUN</span><span class="w"> </span>groupadd<span class="w"> </span>-g<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$GROUPID</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$USERNAME</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-85" name="__codelineno-56-85"></a><span class="w">    </span>adduser<span class="w"> </span>--disabled-password<span class="w"> </span>--gecos<span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span>--uid<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$USERID</span><span class="s2">&quot;</span><span class="w"> </span>--gid<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$GROUPID</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$USERNAME</span><span class="s2">&quot;</span>
<a id="__codelineno-56-86" name="__codelineno-56-86"></a>
<a id="__codelineno-56-87" name="__codelineno-56-87"></a><span class="c"># ==========================================</span>
<a id="__codelineno-56-88" name="__codelineno-56-88"></a><span class="c"># Sorgenti Geant4 11.3.1 (da GitLab CERN)</span>
<a id="__codelineno-56-89" name="__codelineno-56-89"></a><span class="c"># ==========================================</span>
<a id="__codelineno-56-90" name="__codelineno-56-90"></a><span class="k">RUN</span><span class="w"> </span>mkdir<span class="w"> </span>-p<span class="w"> </span>/opt/geant4-source<span class="w"> </span>/tmp/g4<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-91" name="__codelineno-56-91"></a><span class="w">    </span><span class="nb">cd</span><span class="w"> </span>/tmp/g4<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-92" name="__codelineno-56-92"></a><span class="w">    </span>wget<span class="w"> </span>https://gitlab.cern.ch/geant4/geant4/-/archive/v11.3.1/geant4-v11.3.1.tar.gz<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-93" name="__codelineno-56-93"></a><span class="w">    </span>tar<span class="w"> </span>-xzf<span class="w"> </span>geant4-v11.3.1.tar.gz<span class="w"> </span>-C<span class="w"> </span>/opt/geant4-source<span class="w"> </span>--strip-components<span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-94" name="__codelineno-56-94"></a><span class="w">    </span>rm<span class="w"> </span>-rf<span class="w"> </span>/tmp/g4
<a id="__codelineno-56-95" name="__codelineno-56-95"></a>
<a id="__codelineno-56-96" name="__codelineno-56-96"></a><span class="c"># ==========================================</span>
<a id="__codelineno-56-97" name="__codelineno-56-97"></a><span class="c"># Build + install Geant4 (dataset inclusi)</span>
<a id="__codelineno-56-98" name="__codelineno-56-98"></a><span class="c"># ==========================================</span>
<a id="__codelineno-56-99" name="__codelineno-56-99"></a><span class="k">RUN</span><span class="w"> </span>mkdir<span class="w"> </span>-p<span class="w"> </span>/opt/geant4-build<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">cd</span><span class="w"> </span>/opt/geant4-build<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-100" name="__codelineno-56-100"></a><span class="w">    </span>cmake<span class="w"> </span>../geant4-source<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-101" name="__codelineno-56-101"></a><span class="w">      </span>-DCMAKE_INSTALL_PREFIX<span class="o">=</span><span class="si">${</span><span class="nv">G4INSTALL</span><span class="si">}</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-102" name="__codelineno-56-102"></a><span class="w">      </span>-DGEANT4_BUILD_MULTITHREADED<span class="o">=</span>ON<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-103" name="__codelineno-56-103"></a><span class="w">      </span>-DGEANT4_BUILD_CXXSTD<span class="o">=</span><span class="m">17</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-104" name="__codelineno-56-104"></a><span class="w">      </span>-DGEANT4_INSTALL_DATA<span class="o">=</span>ON<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-105" name="__codelineno-56-105"></a><span class="w">      </span>-DGEANT4_INSTALL_EXAMPLES<span class="o">=</span>ON<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-106" name="__codelineno-56-106"></a><span class="w">      </span>-DGEANT4_USE_GDML<span class="o">=</span>ON<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-107" name="__codelineno-56-107"></a><span class="w">      </span>-DGEANT4_USE_SYSTEM_EXPAT<span class="o">=</span>ON<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-108" name="__codelineno-56-108"></a><span class="w">      </span>-DGEANT4_USE_SYSTEM_XERCESC<span class="o">=</span>ON<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-109" name="__codelineno-56-109"></a><span class="w">      </span>-DGEANT4_USE_QT<span class="o">=</span>ON<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-110" name="__codelineno-56-110"></a><span class="w">      </span>-DCMAKE_PREFIX_PATH<span class="o">=</span>/usr/lib/x86_64-linux-gnu/cmake/Qt5<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-111" name="__codelineno-56-111"></a><span class="w">      </span>-DGEANT4_USE_OPENGL_X11<span class="o">=</span>ON<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-112" name="__codelineno-56-112"></a><span class="w">      </span>-DGEANT4_USE_XM<span class="o">=</span>OFF<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-113" name="__codelineno-56-113"></a><span class="w">      </span>-DGEANT4_USE_RAYTRACER_X11<span class="o">=</span>ON<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-114" name="__codelineno-56-114"></a><span class="w">    </span>cmake<span class="w"> </span>--build<span class="w"> </span>.<span class="w"> </span>-j<span class="s2">&quot;</span><span class="k">$(</span>nproc<span class="k">)</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-115" name="__codelineno-56-115"></a><span class="w">    </span>cmake<span class="w"> </span>--install<span class="w"> </span>.<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-116" name="__codelineno-56-116"></a><span class="w">    </span>rm<span class="w"> </span>-rf<span class="w"> </span>/opt/geant4-build
<a id="__codelineno-56-117" name="__codelineno-56-117"></a>
<a id="__codelineno-56-118" name="__codelineno-56-118"></a><span class="c"># =================================================</span>
<a id="__codelineno-56-119" name="__codelineno-56-119"></a><span class="c"># Install ROOT (precompiled per Ubuntu 24.04)</span>
<a id="__codelineno-56-120" name="__codelineno-56-120"></a><span class="c"># =================================================</span>
<a id="__codelineno-56-121" name="__codelineno-56-121"></a><span class="k">RUN</span><span class="w"> </span><span class="nb">cd</span><span class="w"> </span>/opt<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-122" name="__codelineno-56-122"></a><span class="w">    </span>wget<span class="w"> </span>-O<span class="w"> </span>root.tar.gz<span class="w"> </span>https://root.cern/download/root_v6.36.04.Linux-ubuntu24.04-x86_64-gcc13.3.tar.gz<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-123" name="__codelineno-56-123"></a><span class="w">    </span>tar<span class="w"> </span>-xzf<span class="w"> </span>root.tar.gz<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-124" name="__codelineno-56-124"></a><span class="w">    </span>mv<span class="w"> </span>root<span class="w"> </span>root-<span class="si">${</span><span class="nv">ROOT_VERSION</span><span class="si">}</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-125" name="__codelineno-56-125"></a><span class="w">    </span>ln<span class="w"> </span>-s<span class="w"> </span>root-<span class="si">${</span><span class="nv">ROOT_VERSION</span><span class="si">}</span><span class="w"> </span>root<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-126" name="__codelineno-56-126"></a><span class="w">    </span>rm<span class="w"> </span>root.tar.gz
<a id="__codelineno-56-127" name="__codelineno-56-127"></a>
<a id="__codelineno-56-128" name="__codelineno-56-128"></a><span class="c"># =================================================</span>
<a id="__codelineno-56-129" name="__codelineno-56-129"></a><span class="c"># Linker config + PATH/LD_LIBRARY_PATH globali</span>
<a id="__codelineno-56-130" name="__codelineno-56-130"></a><span class="c"># =================================================</span>
<a id="__codelineno-56-131" name="__codelineno-56-131"></a><span class="k">RUN</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">G4LIB_DIR</span><span class="si">}</span><span class="s2">&quot;</span><span class="w">   </span>&gt;<span class="w"> </span>/etc/ld.so.conf.d/geant4.conf<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-132" name="__codelineno-56-132"></a><span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">ROOTSYS</span><span class="si">}</span><span class="s2">/lib&quot;</span><span class="w"> </span>&gt;<span class="w"> </span>/etc/ld.so.conf.d/root.conf<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-133" name="__codelineno-56-133"></a><span class="w">    </span>ldconfig
<a id="__codelineno-56-134" name="__codelineno-56-134"></a>
<a id="__codelineno-56-135" name="__codelineno-56-135"></a><span class="k">ENV</span><span class="w"> </span><span class="nv">PATH</span><span class="o">=</span><span class="si">${</span><span class="nv">G4INSTALL</span><span class="si">}</span>/bin:<span class="si">${</span><span class="nv">ROOTSYS</span><span class="si">}</span>/bin:<span class="si">${</span><span class="nv">PATH</span><span class="si">}</span>
<a id="__codelineno-56-136" name="__codelineno-56-136"></a><span class="k">ENV</span><span class="w"> </span><span class="nv">LD_LIBRARY_PATH</span><span class="o">=</span><span class="si">${</span><span class="nv">G4LIB_DIR</span><span class="si">}</span>:<span class="si">${</span><span class="nv">ROOTSYS</span><span class="si">}</span>/lib
<a id="__codelineno-56-137" name="__codelineno-56-137"></a>
<a id="__codelineno-56-138" name="__codelineno-56-138"></a><span class="c"># ===========================</span>
<a id="__codelineno-56-139" name="__codelineno-56-139"></a><span class="c"># Permessi su /opt/geant4</span>
<a id="__codelineno-56-140" name="__codelineno-56-140"></a><span class="c"># ===========================</span>
<a id="__codelineno-56-141" name="__codelineno-56-141"></a><span class="k">RUN</span><span class="w"> </span>chown<span class="w"> </span>-R<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$USERNAME</span><span class="s2">:</span><span class="nv">$GROUPID</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$G4INSTALL</span><span class="s2">&quot;</span>
<a id="__codelineno-56-142" name="__codelineno-56-142"></a>
<a id="__codelineno-56-143" name="__codelineno-56-143"></a><span class="c"># ======================================================</span>
<a id="__codelineno-56-144" name="__codelineno-56-144"></a><span class="c"># EntryPoint: inizializza Geant4 + ROOT nel modo &quot;giusto&quot;</span>
<a id="__codelineno-56-145" name="__codelineno-56-145"></a><span class="c"># ======================================================</span>
<a id="__codelineno-56-146" name="__codelineno-56-146"></a><span class="k">RUN</span><span class="w"> </span><span class="nb">printf</span><span class="w"> </span><span class="s1">&#39;%s\n&#39;</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-147" name="__codelineno-56-147"></a><span class="s1">&#39;#!/bin/bash&#39;</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-148" name="__codelineno-56-148"></a><span class="s1">&#39;set -e&#39;</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-149" name="__codelineno-56-149"></a><span class="s1">&#39;# --- Geant4 env ---&#39;</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-150" name="__codelineno-56-150"></a><span class="s1">&#39;G4_SH=&quot;${G4INSTALL}/bin/geant4.sh&quot;&#39;</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-151" name="__codelineno-56-151"></a><span class="s1">&#39;if [ -f &quot;$G4_SH&quot; ]; then&#39;</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-152" name="__codelineno-56-152"></a><span class="s1">&#39;  OLD_G4=&quot;$(pwd)&quot;&#39;</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-153" name="__codelineno-56-153"></a><span class="s1">&#39;  cd &quot;$(dirname &quot;$G4_SH&quot;)&quot;&#39;</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-154" name="__codelineno-56-154"></a><span class="s1">&#39;  . ./geant4.sh&#39;</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-155" name="__codelineno-56-155"></a><span class="s1">&#39;  cd &quot;$OLD_G4&quot;&#39;</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-156" name="__codelineno-56-156"></a><span class="s1">&#39;fi&#39;</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-157" name="__codelineno-56-157"></a><span class="s1">&#39;# --- geant4make (opzionale, per vecchi workflow) ---&#39;</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-158" name="__codelineno-56-158"></a><span class="s1">&#39;if [ -f &quot;${G4INSTALL}/share/Geant4-${G4VERSION}/geant4make/geant4make.sh&quot; ]; then&#39;</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-159" name="__codelineno-56-159"></a><span class="s1">&#39;  . &quot;${G4INSTALL}/share/Geant4-${G4VERSION}/geant4make/geant4make.sh&quot;&#39;</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-160" name="__codelineno-56-160"></a><span class="s1">&#39;fi&#39;</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-161" name="__codelineno-56-161"></a><span class="s1">&#39;# --- ROOT env ---&#39;</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-162" name="__codelineno-56-162"></a><span class="s1">&#39;if [ -f &quot;/opt/root/bin/thisroot.sh&quot; ]; then&#39;</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-163" name="__codelineno-56-163"></a><span class="s1">&#39;  OLD_ROOT=&quot;$(pwd)&quot;&#39;</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-164" name="__codelineno-56-164"></a><span class="s1">&#39;  cd /opt/root&#39;</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-165" name="__codelineno-56-165"></a><span class="s1">&#39;  . bin/thisroot.sh&#39;</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-166" name="__codelineno-56-166"></a><span class="s1">&#39;  cd &quot;$OLD_ROOT&quot;&#39;</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-167" name="__codelineno-56-167"></a><span class="s1">&#39;fi&#39;</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-168" name="__codelineno-56-168"></a><span class="s1">&#39;# --- Esegui il comando richiesto ---&#39;</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-169" name="__codelineno-56-169"></a><span class="s1">&#39;exec &quot;$@&quot;&#39;</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-170" name="__codelineno-56-170"></a>&gt;<span class="w"> </span>/usr/local/bin/geant4-entrypoint.sh<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-56-171" name="__codelineno-56-171"></a>chmod<span class="w"> </span>+x<span class="w"> </span>/usr/local/bin/geant4-entrypoint.sh
<a id="__codelineno-56-172" name="__codelineno-56-172"></a>
<a id="__codelineno-56-173" name="__codelineno-56-173"></a><span class="k">WORKDIR</span><span class="w"> </span><span class="s">/home/$USERNAME</span>
<a id="__codelineno-56-174" name="__codelineno-56-174"></a><span class="k">USER</span><span class="w"> </span><span class="s">$USERNAME</span>
<a id="__codelineno-56-175" name="__codelineno-56-175"></a>
<a id="__codelineno-56-176" name="__codelineno-56-176"></a><span class="k">ENTRYPOINT</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;/usr/local/bin/geant4-entrypoint.sh&quot;</span><span class="p">]</span>
<a id="__codelineno-56-177" name="__codelineno-56-177"></a><span class="k">CMD</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;bash&quot;</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
<h3 id="riferimenti-ufficiali-recas">Riferimenti ufficiali ReCaS<a class="headerlink" href="#riferimenti-ufficiali-recas" title="Permanent link">&para;</a></h3>
<p>Per dettagli aggiornati sull’uso di Docker e Dockerfile sul cluster ReCaS si
rimanda alla guida ufficiale:</p>
<ul>
<li><a href="https://jvino.github.io/cluster-hpc-gpu-guides/guides/docker_and_dockerfile/#5-dockerfile">Docker e Dockerfile su ReCaS</a></li>
</ul>
<p>La guida presente in questo documento va intesa come complemento operativo
orientato agli esempi Geant4/ROOT e all’integrazione con HTCondor, non come
sostituto della documentazione ufficiale del cluster.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Torna su
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": ".", "features": ["navigation.sections", "navigation.top", "navigation.tracking", "toc.integrate", "content.code.copy", "content.action.edit"], "search": "assets/javascripts/workers/search.7a47a382.min.js", "tags": null, "translations": {"clipboard.copied": "Copiato", "clipboard.copy": "Copia", "search.result.more.one": "1 altro in questa pagina", "search.result.more.other": "# altri in questa pagina", "search.result.none": "Nessun documento trovato", "search.result.one": "1 documento trovato", "search.result.other": "# documenti trovati", "search.result.placeholder": "Scrivi per iniziare a cercare", "search.result.term.missing": "Non presente", "select.version": "Seleziona la versione"}, "version": null}</script>
    
    
      <script src="assets/javascripts/bundle.e71a0d61.min.js"></script>
      
    
  </body>
</html>